<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dart-Training 301 | Big 20 (v2.7 Voice)</title>
<style>
  :root{
    --bg:#f5f7fb;
    --card:#fff;
    --text:#111;
    --muted:#666;
    --accent:#2979ff;
    --good:#1fa64a;
    --bad:#d22;
    --gold:#f1c40f;
  }
  [data-theme="dark"]{
    --bg:#0b0c0d;
    --card:#121416;
    --text:#efefef;
    --muted:#bfc6cb;
    --accent:#3f79ff;
  }
  html,body{height:100%}
  body{
    margin:0;padding:18px;font-family:Inter,Arial,sans-serif;background:var(--bg);color:var(--text);
  }
  h1{margin:8px 0 16px;font-size:20px;text-align:center}
  .scoreboard{display:flex;justify-content:space-between;align-items:center;background:var(--card);padding:14px 18px;border-radius:12px;max-width:960px;margin:0 auto 18px}
  .stat{font-size:14px;margin:6px 0}
  .stat strong{display:inline-block;width:120px;text-align:left}
  #accuracy{font-size:16px;font-weight:700}
  #status{color:var(--muted);text-align:center;margin-top:6px;min-height:18px}
  .board{display:flex;justify-content:center;gap:28px;max-width:960px;margin:0 auto}
  .col{display:flex;flex-direction:column;gap:12px}
  .btn{width:170px;padding:14px;border-radius:10px;border:0;background:var(--accent);color:#fff;font-size:16px;cursor:pointer;box-shadow:0 4px 8px rgba(0,0,0,0.12);transition:transform .12s,opacity .12s,box-shadow .12s}
  .btn:active{transform:translateY(2px) scale(.995)}
  .btn:disabled{opacity:.45;cursor:not-allowed}
  .btn.hit{transform:scale(1.05);box-shadow:0 10px 22px rgba(0,0,0,0.22);filter:brightness(1.06)}
  #recentArea{max-width:960px;margin:18px auto 0;text-align:center;padding:8px 12px}
  #recentTitle{font-size:16px;margin-bottom:6px}
  #recentVals{font-size:20px;font-weight:700;min-height:28px;opacity:0;transition:opacity .4s}
  #qualityTitle{font-size:18px;margin-top:12px;font-weight:800;text-align:center}
  #qualityVal{font-size:30px;font-weight:900;text-align:center;margin-bottom:8px;min-height:40px}
  #endNotice{margin-top:10px;font-weight:800;color:var(--muted)}
  #restBig{display:block;margin:12px auto 6px;text-align:center;font-weight:900;font-size:44px;color:var(--good);background:transparent}
  #gear{position:fixed;left:14px;bottom:14px;width:48px;height:48px;border-radius:10px;background:var(--card);display:flex;align-items:center;justify-content:center;box-shadow:0 6px 16px rgba(0,0,0,0.12);cursor:pointer}
  #newGame{position:fixed;right:14px;bottom:14px;background:#e53935;color:#fff;border:0;padding:12px 18px;border-radius:30px;box-shadow:0 6px 18px rgba(0,0,0,0.12);cursor:pointer}
  .modal-bg{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;padding:12px}
  .modal{width:100%;max-width:720px;background:var(--card);border-radius:12px;padding:16px;box-shadow:0 12px 30px rgba(0,0,0,0.2);color:var(--text)}
  .modal h2{margin:0 0 10px}
  .sound-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px}
  .sound-sample{padding:8px 12px;border-radius:8px;background:#eef4ff;border:1px solid #d7e8ff;cursor:pointer;color:#001}
  .modal select{width:100%;padding:8px;border-radius:8px;border:1px solid #ccc;margin-bottom:6px}
  .footer-note{font-size:13px;color:var(--muted);margin-top:8px}
  .hidden{display:none!important}
  .voice-indicator{font-size:13px;margin-top:8px;color:var(--muted)}
  @media (max-width:560px){ .board{flex-direction:row;gap:12px} .btn{width:140px;font-size:15px} #qualityVal{font-size:22px} #restBig{font-size:34px} .sound-grid{grid-template-columns:1fr} }
</style>
</head>
<body>
<h1>Dart-Training 301 | Big 20 (v2.7 Voice)</h1>

<div class="scoreboard" role="region" aria-label="Scoreboard">
  <div>
    <div class="stat"><strong>Restpunkte:</strong></div>
    <div id="restBig">301</div>
  </div>
  <div style="text-align:right">
    <div class="stat"><strong>Treffer</strong></div>
    <div id="hitSummary">0 von 0</div>
    <div id="status"></div>
  </div>
</div>

<div id="board" class="board" aria-live="polite">
  <div class="col" id="leftCol">
    <button class="btn" id="btnT" data-val="60" data-label="Triple-20">Triple-20</button>
    <button class="btn" id="btnD" data-val="40" data-label="Doppel-20">Doppel-20</button>
    <button class="btn" id="btnS" data-val="20" data-label="Single-20">Single-20</button>
  </div>

  <div class="col" id="rightCol">
    <button class="btn" id="btnBE" data-val="50" data-label="Bulls Eye">Bulls Eye</button>
    <button class="btn" id="btnB" data-val="25" data-label="Bull">Bull</button>
    <button class="btn" id="btn0" data-val="0" data-label="Null">Null</button>
  </div>
</div>

<div id="recentArea">
  <div id="recentTitle">Zuletzt geworfen</div>
  <div id="recentVals"></div>
  <div id="qualityTitle">Wurfqualitaet gesamt</div>
  <div id="qualityVal">–</div>
  <div id="endNotice"></div>
  <div class="voice-indicator" id="voiceIndicator">Sprache: aus</div>
</div>

<div id="gear" title="Einstellungen">⚙</div>
<button id="newGame">Neues Spiel</button>

<div id="modalBg" class="modal-bg" role="dialog" aria-modal="true">
  <div class="modal" role="document">
    <h2>Einstellungen</h2>
    <div style="display:flex;gap:18px;flex-wrap:wrap">
      <div style="flex:1;min-width:220px">
        <label style="color:var(--text)"><input type="checkbox" id="toggleDark"> Darkmode</label>
        <div style="margin-top:8px">
          <div style="font-weight:600;margin-bottom:6px">Sound-Test</div>
          <div class="sound-grid" id="soundList"></div>
          <div class="footer-note">Klicke einen Sound, um ihn zu pruefen. Wähle dann Zuweisungen.</div>
        </div>
      </div>

      <div style="flex:1;min-width:220px">
        <div style="font-weight:600;margin-bottom:6px">Sound-Zuweisungen</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <div>
            <label style="display:block">Single-20 <select id="selSingle"></select></label>
            <label style="display:block">Doppel-20 <select id="selDouble"></select></label>
            <label style="display:block">Triple-20 <select id="selTriple"></select></label>
          </div>
          <div>
            <label style="display:block">Bull <select id="selBull"></select></label>
            <label style="display:block">Bulls Eye <select id="selBE"></select></label>
            <label style="display:block">Null <select id="selZero"></select></label>
          </div>
        </div>
        <div style="margin-top:8px">
          <label><input type="checkbox" id="voiceToggle"> Sprachsteuerung (aktivieren)</label>
          <div class="small">Spracheingabe startet mit dem Wort <strong>"Plus"</strong> (Deutsch).</div>
        </div>
      </div>
    </div>

    <div style="margin-top:12px;text-align:right">
      <button id="saveSettings" style="padding:8px 12px;border-radius:8px;border:0;background:#2979ff;color:#fff">Speichern</button>
      <button id="closeSettings" style="padding:8px 12px;border-radius:8px;border:0;margin-left:8px">Schliessen</button>
    </div>
  </div>
</div>

<script>
/* Big 20 v2.7: add hybrid speech control keyword "Plus" (de-DE).
   Keeps UI unchanged; voice optional via settings. */

let score = 301, throws = 0, hits = 0, recent = [], roundThrows = 0, locked = false;

/* UI refs */
const restBig = document.getElementById('restBig');
const hitSummary = document.getElementById('hitSummary');
const statusEl = document.getElementById('status');
const recentVals = document.getElementById('recentVals');
const qualityVal = document.getElementById('qualityVal');
const endNotice = document.getElementById('endNotice');
const modalBg = document.getElementById('modalBg');
const gear = document.getElementById('gear');
const newGameBtn = document.getElementById('newGame');
const voiceIndicator = document.getElementById('voiceIndicator');

let audioCtx = null;
function ensureAudio(){ if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }

/* sounds (same as v2.6) */
function playWoodClick(t=0){ ensureAudio(); const now=audioCtx.currentTime+t; const buf=audioCtx.createBuffer(1,Math.floor(0.03*audioCtx.sampleRate),audioCtx.sampleRate); const d=buf.getChannelData(0); for(let i=0;i<d.length;i++) d[i]=(Math.random()*2-1)*Math.exp(-14*i/d.length); const src=audioCtx.createBufferSource(); src.buffer=buf; const filt=audioCtx.createBiquadFilter(); filt.type='bandpass'; filt.frequency.value=1200; filt.Q.value=1.4; const g=audioCtx.createGain(); g.gain.setValueAtTime(0.0001,now); g.gain.setValueAtTime(0.16,now); g.gain.exponentialRampToValueAtTime(0.00001,now+0.06); src.connect(filt); filt.connect(g); g.connect(audioCtx.destination); src.start(now); src.stop(now+0.06); }
function playSoftPop(t=0){ ensureAudio(); const now=audioCtx.currentTime+t; const o=audioCtx.createOscillator(),g=audioCtx.createGain(); o.type='triangle'; o.frequency.setValueAtTime(700,now); g.gain.setValueAtTime(0.0001,now); g.gain.linearRampToValueAtTime(0.12,now+0.01); g.gain.exponentialRampToValueAtTime(0.0001,now+0.09); o.connect(g); g.connect(audioCtx.destination); o.start(now); o.stop(now+0.1); }
function playDingDong(t=0){ ensureAudio(); const now=audioCtx.currentTime+t; const o1=audioCtx.createOscillator(),g1=audioCtx.createGain(); o1.type='sine'; o1.frequency.setValueAtTime(820,now); g1.gain.setValueAtTime(0.12,now); g1.gain.exponentialRampToValueAtTime(0.0001,now+0.22); o1.connect(g1); g1.connect(audioCtx.destination); o1.start(now); o1.stop(now+0.22); setTimeout(()=>{ const o2=audioCtx.createOscillator(),g2=audioCtx.createGain(); const t0=audioCtx.currentTime; o2.type='sine'; o2.frequency.value=440; g2.gain.setValueAtTime(0.08,t0); g2.gain.exponentialRampToValueAtTime(0.0001,t0+0.36); o2.connect(g2); g2.connect(audioCtx.destination); o2.start(t0); o2.stop(t0+0.36); },120); }
function playGongLoud(t=0){ ensureAudio(); const now=audioCtx.currentTime+t; const o=audioCtx.createOscillator(),g=audioCtx.createGain(); o.type='sine'; o.frequency.setValueAtTime(180,now); g.gain.setValueAtTime(0.28,now); g.gain.exponentialRampToValueAtTime(0.0001,now+1.4); o.connect(g); g.connect(audioCtx.destination); o.start(now); o.frequency.exponentialRampToValueAtTime(60,now+1.4); o.stop(now+1.45); if(navigator.vibrate) navigator.vibrate([160,80,160]); }
function playBuzz(t=0){ ensureAudio(); const now=audioCtx.currentTime+t; const o=audioCtx.createOscillator(),g=audioCtx.createGain(); o.type='square'; o.frequency.setValueAtTime(160,now); g.gain.setValueAtTime(0.15,now); g.gain.exponentialRampToValueAtTime(0.0001,now+0.22); o.connect(g); g.connect(audioCtx.destination); o.start(now); o.stop(now+0.22); }
function playEndChord(){ ensureAudio(); const now=audioCtx.currentTime; const freqs=[660,820,1040]; freqs.forEach((f,i)=>{ const o=audioCtx.createOscillator(),g=audioCtx.createGain(); o.type='sine'; o.frequency.setValueAtTime(f, now + i*0.12); g.gain.setValueAtTime(0.0001, now + i*0.12); g.gain.linearRampToValueAtTime(0.12, now + i*0.12 + 0.02); g.gain.exponentialRampToValueAtTime(0.0001, now + i*0.12 + 0.6); o.connect(g); g.connect(audioCtx.destination); o.start(now + i*0.12); o.stop(now + i*0.12 + 0.7); }); }

/* sound mapping */
const soundSlots = [
  {id:'s1',name:'Wood click 1',fn:playWoodClick},
  {id:'s2',name:'Wood pop',fn:playSoftPop},
  {id:'s3',name:'Pop short',fn:playSoftPop},
  {id:'s4',name:'Ding dong',fn:playDingDong},
  {id:'s5',name:'Gong loud',fn:playGongLoud},
  {id:'s6',name:'Buzz',fn:playBuzz}
];
let mapping = { single:'s1', double:'s1', triple:'s1', bull:'s4', bullseye:'s5', zero:'s6' };
try{ const sv = localStorage.getItem('dt_sound_map_v25'); if(sv) mapping = JSON.parse(sv); const th = localStorage.getItem('dt_theme_v25'); if(th==='dark') document.documentElement.setAttribute('data-theme','dark'); }catch(e){}

/* settings UI build (reuse previous selects) */
const soundList = document.getElementById('soundList');
const selSingle = document.getElementById('selSingle');
const selDouble = document.getElementById('selDouble');
const selTriple = document.getElementById('selTriple');
const selBull = document.getElementById('selBull');
const selBE = document.getElementById('selBE');
const selZero = document.getElementById('selZero');
const voiceToggle = document.getElementById('voiceToggle');

function buildSoundUI(){
  soundList.innerHTML=''; [selSingle,selDouble,selTriple,selBull,selBE,selZero].forEach(s=>s.innerHTML='');
  soundSlots.forEach(slot=>{
    const d=document.createElement('div'); d.className='sound-sample'; d.textContent=slot.name;
    d.onclick = ()=> { try{ slot.fn(); }catch(e){} };
    soundList.appendChild(d);
    [selSingle,selDouble,selTriple,selBull,selBE,selZero].forEach(sel=>{
      const o=document.createElement('option'); o.value=slot.id; o.textContent=slot.name; sel.appendChild(o);
    });
  });
  selSingle.value=mapping.single; selDouble.value=mapping.double; selTriple.value=mapping.triple;
  selBull.value=mapping.bull; selBE.value=mapping.bullseye; selZero.value=mapping.zero;
}
buildSoundUI();

/* modal handlers */
gear.addEventListener('click', ()=> modalBg.style.display='flex');
document.getElementById('closeSettings').addEventListener('click', ()=> modalBg.style.display='none');
document.getElementById('saveSettings').addEventListener('click', ()=>{
  mapping = { single:selSingle.value, double:selDouble.value, triple:selTriple.value, bull:selBull.value, bullseye:selBE.value, zero:selZero.value };
  localStorage.setItem('dt_sound_map_v25', JSON.stringify(mapping));
  const d = document.getElementById('toggleDark').checked;
  if(d){ document.documentElement.setAttribute('data-theme','dark'); localStorage.setItem('dt_theme_v25','dark'); } else { document.documentElement.removeAttribute('data-theme'); localStorage.setItem('dt_theme_v25','light'); }
  // voice toggle persist
  localStorage.setItem('dt_voice_v27', document.getElementById('voiceToggle').checked ? '1' : '0');
  modalBg.style.display='none';
  // update UI indicator
  updateVoiceIndicator();
});

/* compute quality */
function computeQuality(){
  const totalPoints = (301 - score);
  if(throws===0) return null;
  const q = (totalPoints / (throws * 50)) * 100;
  return Math.min(120, q);
}

/* update UI */
function updateUI(){
  restBig.textContent = score;
  restBig.style.color = score>0 ? 'var(--good)' : 'var(--muted)';
  hitSummary.textContent = `${hits} von ${throws}`;
  const q = computeQuality();
  if(q===null){ qualityVal.textContent='–'; qualityVal.style.color='var(--muted)'; }
  else { let displayQ = q; if(score===0) displayQ = Math.max(displayQ,100); qualityVal.textContent = displayQ.toFixed(1)+' %'; qualityVal.style.color = displayQ>=100? 'var(--gold)' : (displayQ>=50? 'var(--good)' : 'var(--bad)'); }
  if(score<=0){ endNotice.textContent='Spielende'; document.querySelectorAll('.btn').forEach(b=> b.classList.add('hidden')); playEndChord(); } else { endNotice.textContent=''; }
}

/* play mapped sound */
function playMapped(slotId, t=0){ const s = soundSlots.find(x=>x.id===slotId); if(!s) return; try{ s.fn(t);}catch(e){} }

/* mapping rules for multi-play */
function playForAction(action){
  if(action==='single'){ playMapped(mapping.single,0); return; }
  if(action==='double'){ playMapped(mapping.single,0); setTimeout(()=>playMapped(mapping.single,0),200); return; }
  if(action==='triple'){ playMapped(mapping.single,0); setTimeout(()=>playMapped(mapping.single,0),200); setTimeout(()=>playMapped(mapping.single,0),400); return; }
  if(action==='bull'){ playMapped(mapping.bull,0); return; }
  if(action==='bullseye'){ playMapped(mapping.bullseye,0); return; }
  if(action==='zero'){ playMapped(mapping.zero,0); return; }
}

/* animate button */
function animateButton(el){ if(!el) return; el.classList.add('hit'); setTimeout(()=>el.classList.remove('hit'),160); }
function setButtonsEnabled(enabled){ document.querySelectorAll('.btn').forEach(b=> b.disabled = !enabled); }
function isOver(before, scored){ return scored > before; }

/* handleThrow (same behavior as v2.6) */
function handleThrow(points,label,btnEl){
  if(locked || score<=0) return;
  if(audioCtx && audioCtx.state==='suspended') audioCtx.resume();
  statusEl.textContent=''; throws++; roundThrows++;
  const over = isOver(score, points);
  if(points>0 && !over && points<=score) hits++;
  if(!over && points<=score) score-=points;
  else if(over){
    statusEl.textContent='ueberworfen!';
    playForAction('zero');
    locked=true; setButtonsEnabled(false);
    recent.unshift(label); if(recent.length>3) recent.pop();
    recentVals.textContent = recent.join(', ');
    recentVals.style.opacity = 1;
    restBig.style.color = 'var(--bad)';
    if(navigator.vibrate) navigator.vibrate(120);
    setTimeout(()=>{ restBig.style.color = (score>0 ? 'var(--good)' : 'var(--muted)'); recentVals.style.opacity = 0; locked=false; setButtonsEnabled(true); roundThrows=0; statusEl.textContent=''; },10000);
    updateUI();
    return;
  }
  if(points===60) playForAction('triple'); else if(points===40) playForAction('double'); else if(points===20) playForAction('single'); else if(points===25) playForAction('bull'); else if(points===50) playForAction('bullseye'); else if(points===0) playForAction('zero');
  animateButton(btnEl);
  recent.unshift(label); if(recent.length>3) recent.pop();
  updateUI();
  if(score>0 && score<60){ setTimeout(()=>{ showCheckoutOptions(); },120); return; }
  if(roundThrows>=3){ locked=true; setButtonsEnabled(false); recentVals.textContent = recent.join(', '); recentVals.style.opacity = 1; setTimeout(()=>{ recentVals.style.opacity = 0; locked=false; setButtonsEnabled(true); roundThrows = 0; },10000); }
}

/* bind buttons */
function bindDefaultButtons(){
  const bT = document.getElementById('btnT');
  const bD = document.getElementById('btnD');
  const bS = document.getElementById('btnS');
  const bBE = document.getElementById('btnBE');
  const bB = document.getElementById('btnB');
  const b0 = document.getElementById('btn0');
  if(bT && !bT._bound){ bT.addEventListener('click', function(){ handleThrow(60,'Triple-20', this); }); bT._bound=true; }
  if(bD && !bD._bound){ bD.addEventListener('click', function(){ handleThrow(40,'Doppel-20', this); }); bD._bound=true; }
  if(bS && !bS._bound){ bS.addEventListener('click', function(){ handleThrow(20,'Single-20', this); }); bS._bound=true; }
  if(bBE && !bBE._bound){ bBE.addEventListener('click', function(){ handleThrow(50,'Bulls Eye', this); }); bBE._bound=true; }
  if(bB && !bB._bound){ bB.addEventListener('click', function(){ handleThrow(25,'Bull', this); }); bB._bound=true; }
  if(b0 && !b0._bound){ b0.addEventListener('click', function(){ handleThrow(0,'Null', this); }); b0._bound=true; }
}
bindDefaultButtons();
updateUI();

/* checkout options */
function showCheckoutOptions(){
  const board = document.getElementById('board'); board.innerHTML=''; const col=document.createElement('div'); col.className='col';
  const b0=document.createElement('button'); b0.className='btn'; b0.textContent='Null'; b0.onclick=()=>handleThrow(0,'Null',b0); col.appendChild(b0);
  const bex=document.createElement('button'); bex.className='btn'; bex.textContent=String(score); bex.onclick=(()=>handleThrow(score,String(score),bex)); col.appendChild(bex);
  for(let s=1;s<=20;s++){ if(3*s===score){ const bt=document.createElement('button'); bt.className='btn'; bt.textContent='Triple '+s; bt.onclick=(()=>handleThrow(3*s,'Triple '+s,bt)); col.appendChild(bt);} if(2*s===score){ const bd=document.createElement('button'); bd.className='btn'; bd.textContent='Doppel '+s; bd.onclick=(()=>handleThrow(2*s,'Doppel '+s,bd)); col.appendChild(bd);} }
  board.appendChild(col);
}

/* new game */
newGameBtn.addEventListener('click', ()=>{
  score=301; throws=0; hits=0; recent=[]; roundThrows=0; locked=false;
  bindDefaultButtons();
  updateUI();
  recentVals.textContent=''; recentVals.style.opacity=0; endNotice.textContent='';
  document.querySelectorAll('.btn').forEach(b=> b.classList.remove('hidden'));
});

/* Voice recognition setup */
let recognition = null;
let voiceActive = false;
function updateVoiceIndicator(){ voiceIndicator.textContent = 'Sprache: ' + (voiceActive? 'an' : 'aus'); }
function initRecognition(){
  if(!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) return false;
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SR();
  recognition.lang = 'de-DE';
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;
  recognition.continuous = true;
  recognition.onresult = (e)=> {
    const text = e.results[e.results.length-1][0].transcript.trim().toLowerCase();
    console.log('speech result:', text);
    processSpeech(text);
  };
  recognition.onerror = (ev)=> {
    console.warn('speech error', ev);
    if(ev.error === 'not-allowed' || ev.error==='service-not-allowed'){
      // permission denied
      voiceActive=false; updateVoiceIndicator(); alert('Mikrofon-Zugriff verweigert. Spracheingabe deaktiviert.');
    }
  };
  recognition.onend = ()=> {
    // auto-restart when active
    if(voiceActive){
      try{ recognition.start(); }catch(e){ console.warn('restart failed', e); }
    }
  };
  return true;
}
initRecognition();

/* map german number words to numbers */
const numWords = {
  'null':0,'eins':1,'ein':1,'zwei':2,'drei':3,'vier':4,'fuenf':5,'fünf':5,'sechs':6,'sieben':7,'acht':8,'neun':9,'zehn':10,
  'elf':11,'zwoelf':12,'zwölf':12,'dreizehn':13,'vierzehn':14,'fuenfzehn':15,'fünfzehn':15,'sechzehn':16,'siebzehn':17,'achtzehn':18,'neunzehn':19,'zwanzig':20
};

/* speech processing */
function speakText(text){
  try{
    const u = new SpeechSynthesisUtterance(text);
    u.lang = 'de-DE';
    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  }catch(e){}
}

function processSpeech(raw){
  // expects commands starting with "plus"
  if(!raw) return;
  // normalize
  let t = raw.replace(/[^\wäöüß\s]/g,' ').replace(/\s+/g,' ').trim();
  if(!t.startsWith('plus ')){
    // ignore everything not starting with plus
    console.log('ignored speech (no plus)', t);
    return;
  }
  const cmd = t.slice(5).trim(); // after 'plus '
  if(!cmd){
    speakText('Wie bitte?');
    return;
  }
  // try to detect patterns:
  // triple 20, doppel 20, double 20, bullseye, bull, numbers 0-20
  let matched = false;
  // triple
  if(/^(triple|trippel|dreifach|dreifach )/.test(cmd) || cmd.startsWith('triple') || cmd.includes('triple')){
    // find number
    const m = cmd.match(/(\d+)|([a-zäöü]+)/);
    let n = null;
    if(m){
      const token = m[0];
      n = parseInt(token);
      if(isNaN(n) && numWords[token]) n = numWords[token];
    }
    if(n===20 || n===null){
      // default triple 20 if no number
      matched = true;
      // play single sound repeated 3x via mapping
      playForAction('triple');
      handleThrow(60,'Triple-20', document.getElementById('btnT'));
    }
  }
  // double
  if(!matched && (cmd.startsWith('doppel') || cmd.startsWith('double') || cmd.includes('doppel'))){
    matched = true;
    playForAction('double');
    handleThrow(40,'Doppel-20', document.getElementById('btnD'));
  }
  // triple keyword direct "triple 20"
  if(!matched && cmd.match(/triple.*20|triple.*zwanzig|dreifach.*20/)){
    matched = true;
    playForAction('triple');
    handleThrow(60,'Triple-20', document.getElementById('btnT'));
  }
  // bulls eye
  if(!matched && (cmd.includes('bullseye') || cmd.includes('bulls eye') || cmd.includes('bulls-eye') || cmd==='bulls eye' || cmd==='bullseye' || cmd==='bulls')) {
    matched = true;
    playForAction('bullseye');
    handleThrow(50,'Bulls Eye', document.getElementById('btnBE'));
  }
  // bull
  if(!matched && (cmd==='bull' || cmd==='bulle' || cmd.includes('bull ') || cmd.includes(' bull'))){
    matched = true;
    playForAction('bull');
    handleThrow(25,'Bull', document.getElementById('btnB'));
  }
  // explicit zero
  if(!matched && (cmd==='null' || cmd==='fehler' || cmd==='fehlwurf' || cmd==='nichts')){
    matched = true;
    playForAction('zero');
    handleThrow(0,'Null', document.getElementById('btn0'));
  }
  // numeric 1-20
  if(!matched){
    // try to extract number token
    const numMatch = cmd.match(/\d+/);
    let val = null;
    if(numMatch){
      val = parseInt(numMatch[0]);
    } else {
      // try word map
      const words = cmd.split(' ');
      for(let w of words){
        if(numWords[w] !== undefined){ val = numWords[w]; break; }
      }
    }
    if(val !== null && !isNaN(val)){
      if(val>=1 && val<=20){
        matched = true;
        // If val==20 -> single20
        if(val===20){
          playForAction('single');
          handleThrow(20,'Single-20', document.getElementById('btnS'));
        } else {
          // Only allow single numbers if they are allowed per Big20 rules:
          // The user requested 1-20 allowed. We'll treat as single value.
          playForAction('single');
          handleThrow(val, String(val), null);
        }
      } else if(val===25){
        matched = true;
        playForAction('bull');
        handleThrow(25,'Bull', document.getElementById('btnB'));
      } else if(val===50){
        matched = true;
        playForAction('bullseye');
        handleThrow(50,'Bulls Eye', document.getElementById('btnBE'));
      }
    }
  }
  if(!matched){
    // didn't understand
    speakText('Wie bitte?');
    console.log('unrecognized cmd:', cmd);
  }
  // update UI and persist if needed
  updateUI();
}

/* voice control toggle handlers */
function startVoice(){
  if(!recognition){ if(!initRecognition()){ alert('Spracherkennung wird in diesem Browser nicht unterstützt.'); return; } }
  try{
    recognition.start();
    voiceActive = true;
    updateVoiceIndicator();
  }catch(e){ console.warn('start failed', e); }
}
function stopVoice(){
  if(recognition){
    try{ recognition.stop(); }catch(e){ console.warn('stop failed', e); }
  }
  voiceActive = false;
  updateVoiceIndicator();
}

/* restore persisted voice setting */
try{
  const vs = localStorage.getItem('dt_voice_v27');
  if(vs==='1'){ document.getElementById('voiceToggle').checked = true; startVoice(); }
} catch(e){}

/* update indicator */
function updateVoiceIndicator(){ voiceIndicator.textContent = 'Sprache: ' + (voiceActive? 'an' : 'aus'); }

/* wire voice toggle checkbox */
document.getElementById('voiceToggle').addEventListener('change', function(){
  localStorage.setItem('dt_voice_v27', this.checked ? '1' : '0');
  if(this.checked) startVoice(); else stopVoice();
});

/* resume audio on user gesture */
document.addEventListener('click', function resume(){ if(audioCtx && audioCtx.state==='suspended') audioCtx.resume(); document.removeEventListener('click', resume); });

/* helper: speak 'wie bitte' - already defined with speakText() */

/* init UI */
updateUI();
updateVoiceIndicator();

</script>
</body>
</html>
