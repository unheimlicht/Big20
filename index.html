<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Big-20 | Dart-Training (v3.25 Akkordeon & Live-Ansage)</title>
<style>
/* 1. Farb-Variablen */
:root{
  --bg:#f5f7fb; --card:#fff; --text:#111; --muted:#666; --accent:#2979ff; --good:#1fa64a; --bad:#d22;
  --dark-bg:#000; --dark-card:#0b0b0b; --dark-text:#eaeaea; --dark-muted:#9a9a9a;
  
  /* NEU: Farben f√ºr Icons und Feedback */
  --gear-color: #fdd835; 
  --dart-color: #e53935; 
  --mic-color-active: #1fa64a; 
  --mic-color-inactive: #666; 
  --mic-color-busy: #ff9800; /* Orange f√ºr Verarbeiten */
  --feedback-bg: rgba(255, 255, 255, 0.9);
}
html[data-theme="dark"]{ 
    --bg:var(--dark-bg); --card:var(--dark-card); --text:var(--dark-text); --muted:var(--dark-muted); 
    --feedback-bg: rgba(0, 0, 0, 0.9);
}

/* 2. BODY / Hintergrundbild */
body{
    margin:0;padding:18px;font-family:Inter,Arial,sans-serif;
    /* Bitte sicherstellen, dass das Bild im gleichen Ordner liegt, falls der Pfad nicht funktioniert. */
    background: var(--bg) url("https://raw.githubusercontent.com/unheimlicht/Big20/refs/heads/main/20251109_194725-COLLAGE%7E7.jpg") no-repeat center center fixed; 
    background-size: cover; 
    background-color: #000; 
    color:var(--text);-webkit-font-smoothing:antialiased;
    transition: background-color 0.3s;
}

html[data-theme="dark"] body { 
    background: var(--dark-bg);
    background-image: none !important;
}

/* 3. Optische Verbesserungen */
h1 {
  /* GLOW-EFFEKT */
  text-shadow:
    0 0 6px rgba(255, 255, 255, 0.8), 
    0 0 12px rgba(255, 255, 255, 0.6);
  letter-spacing: 0.5px;
  text-align:center;
  margin:8px 0 0;
  font-size:20px
}

#headlineSpacer { height: 12px; display: block; }

.scoreboard {
  display:flex;justify-content:space-between;align-items:center;
  background: rgba(255, 255, 255, 0.4); 
  backdrop-filter: blur(18px) saturate(200%); 
  -webkit-backdrop-filter: blur(18px) saturate(200%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 16px;
  max-width:960px;margin:0 auto 12px;
  box-shadow:
    0 6px 16px rgba(0, 0, 0, 0.3),
    0 12px 40px rgba(0, 0, 0, 0.25);
  padding:12px 14px;
  transition: all 0.3s ease; /* √úbergang f√ºr Voice Mode */
}
html[data-theme="dark"] .scoreboard {
  background: rgba(0, 0, 0, 0.4);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.score-details { text-align:right; }
.score-details #summary { display: block; font-size:13px; font-weight:500; margin-top:4px; color: var(--muted); } 
.score-details #qualityVal { font-size:20px; font-weight:800; margin-top:6px; }

/* NEU: Voice Mode Scoreboard Styles */
.scoreboard.voice-mode {
    flex-direction: column;
    text-align: center;
    padding: 20px 14px;
}
.scoreboard.voice-mode #restBig {
    font-size: 60px; /* Deutlich gr√∂√üer */
}
.scoreboard.voice-mode .score-details {
    text-align: center;
    margin-top: 12px;
}
.scoreboard.voice-mode .score-details #summary {
    font-size: 15px; 
    margin-top: 0;
}
.scoreboard.voice-mode .score-details #qualityVal {
    font-size: 24px;
}
/* ENDE Voice Mode Scoreboard Styles */


.btn {
  width:150px;padding:12px;margin:6px;border-radius:10px;border:0;background:var(--accent);color:#fff;font-size:16px;cursor:pointer;
  box-shadow: 0 8px 18px rgba(0, 0, 0, 0.4); 
  transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.15s ease;
}
.btn:hover {
  transform: translateY(-3px);
  box-shadow:
    0 12px 24px rgba(0, 0, 0, 0.4),
    0 4px 10px rgba(0, 128, 255, 0.4); 
}
.btn:active {
  transform: translateY(1px) scale(0.97);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.iconBtn{width:44px;height:44px;border-radius:8px;background:var(--card);display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,0.06)}

/* NEUE STYLE F√úR MIKROFON STATUS */
.mic-active {
    background: var(--card);
    animation: pulse 1.5s infinite;
}
.mic-active svg {
    stroke: var(--mic-color-active);
}
.mic-busy svg {
    stroke: var(--mic-color-busy); /* Orange */
    animation: none;
}
@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(31, 166, 74, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(31, 166, 74, 0); }
    100% { box-shadow: 0 0 0 0 rgba(31, 166, 74, 0); }
}
.mic-inactive svg {
    stroke: var(--mic-color-inactive);
}
/* ENDE NEUE STYLE */


/* Bestehende Styles */
#fixedHighscoreFooter {
  position: fixed;
  bottom: 60px;
  left: 0;
  right: 0;
  text-align: center;
  z-index: 90;
  pointer-events: none;
  padding: 0 18px;
  max-width: 960px;
  margin: 0 auto;
}
#headerHighscore {
  text-shadow: 0 0 4px rgba(255, 255, 255, 1), 0 0 8px rgba(255, 255, 255, 0.8);
  letter-spacing: 0.5px;
  font-size: 20px; 
  font-weight: 800; 
  color: var(--text);
  line-height: 1.3;
}
html[data-theme="dark"] #headerHighscore {
    text-shadow: 0 0 4px rgba(0, 0, 0, 0.8), 0 0 8px rgba(0, 0, 0, 0.6); 
    color: var(--dark-text);
}
.btn:disabled{opacity:.5;cursor:not-allowed;background:#e9e9ea;color:#777;box-shadow:none}
.flash-green{animation:flashGreen .45s ease-out}
.flash-red{animation:flashRed .45s ease-out}
@keyframes flashGreen{0%{box-shadow:0 6px 0 rgba(0,0,0,0.06)}40%{box-shadow:0 28px 48px 12px rgba(40,200,80,0.6)}100%{box-shadow:0 6px 0 rgba(0,0,0,0.06)}}
@keyframes flashRed{0%{box-shadow:0 6px 0 rgba(0,0,0,0.06)}40%{box-shadow:0 28px 48px 12px rgba(220,40,40,0.6)}100%{box-shadow:0 6px 0 rgba(0,0,0,0.06)}}
#restBig{text-align:center;font-size:44px;font-weight:900;color:var(--good);margin:6px 0}
#board{display:flex;justify-content:center;gap:28px;max-width:960px;margin:0 auto;min-height:160px; transition: opacity 0.3s;}
.col{display:flex;flex-direction:column;align-items:center}
.undercol{display:flex;flex-direction:column;align-items:center;gap:8px}
#newGame{position:fixed;right:14px;bottom:14px;background:#e53935;color:#fff;border:0;padding:10px 16px;border-radius:30px;cursor:pointer;z-index:100; transition: opacity 0.3s;}
/* footer and controls */
#controls{position:fixed;left:14px;bottom:14px;display:flex;align-items:center;gap:10px;z-index:100}

.version{font-size:11px;color:var(--muted);display:block;text-align:center;margin-top:4px}
/* settings modal */
.modalShade{position:fixed;inset:0;background:rgba(0,0,0,0.35);display:none;align-items:center;justify-content:center;z-index:200}
/* FIX: Max-Height und Scrollbarkeit f√ºr Modal */
.modal{
    background:var(--card);padding:18px;border-radius:12px;min-width:320px;max-width:760px;
    box-shadow:0 12px 40px rgba(0,0,0,0.25);color:var(--text);
    max-height: 90vh; /* NEU */
    overflow-y: auto; /* NEU */
}
.modal h2{margin:0 0 8px;font-size:18px}
.row{display:flex;gap:12px;align-items:center;margin:8px 0}
.col-auto{display:flex;flex-direction:column;gap:8px}
.twoCol{display:grid;grid-template-columns:1fr 1fr;gap:8px}

/* Sound-Zuweisungen (Rechtsb√ºndig) */
.col-auto label {
  display: flex;
  justify-content: space-between;
  align-items: center; 
  gap: 8px; 
}
select,input[type="checkbox"], input[type="radio"]{padding:8px;font-size:14px}
select {
    flex-grow: 1; 
    min-width: 100px;
    text-align: right; 
}

.saveRow{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}
/* sound buttons */
.soundBtn{
    padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);background:transparent;cursor:pointer;
    color: var(--text);
}
/* FIX: Darkmode Kontrast f√ºr Sound Buttons */
html[data-theme="dark"] .soundBtn {
    border: 1px solid rgba(255, 255, 255, 0.15);
    background: rgba(255, 255, 255, 0.05);
}
.soundGrid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.small{font-size:13px;color:var(--muted)}

/* NEU: Details/Akkordeon Style */
details {
    margin: 12px 0;
    border: 1px solid rgba(0,0,0,0.1);
    border-radius: 8px;
    padding: 0;
    overflow: hidden;
}
details summary {
    padding: 10px 14px;
    cursor: pointer;
    background: rgba(0,0,0,0.02);
    font-weight: 600;
    list-style: none; /* Versteckt den Standardpfeil */
    position: relative;
}
details summary::after {
    content: '‚ñº';
    position: absolute;
    right: 14px;
    top: 50%;
    transform: translateY(-50%) rotate(0deg);
    transition: transform 0.2s;
    font-size: 10px;
}
details[open] summary::after {
    transform: translateY(-50%) rotate(180deg);
}
html[data-theme="dark"] details {
    border: 1px solid rgba(255,255,255,0.1);
}
html[data-theme="dark"] details summary {
    background: rgba(255,255,255,0.05);
}
/* Ende Details Style */

/* Countdown Schrift */
.pauseLayer{position:fixed;left:0;right:0;bottom:0;top:0;display:none;align-items:center;justify-content:center;pointer-events:none;z-index:40}
.pauseShade{
  position:absolute;
  inset:0;
  background:rgba(0,0,0,0.1); 
  backdrop-filter: blur(4px); 
  -webkit-backdrop-filter: blur(4px);
  pointer-events:auto
}
.pauseInfo{
  position:relative;
  z-index:41;
  text-align:center;
  pointer-events:none;
  transform: translateY(0px); 
}
.pauseCount{
  font-size:80px; 
  font-weight:900;
  color: #000; 
  margin-bottom:12px;
  text-shadow:
    0 0 8px rgba(255, 255, 255, 1),
    0 0 16px rgba(255, 255, 255, 0.8),
    0 0 24px rgba(255, 255, 255, 0.6);
}
html[data-theme="dark"] .pauseCount {
    color: #fff;
    text-shadow: 
        0 0 8px rgba(0, 0, 0, 1),
        0 0 16px rgba(0, 0, 0, 0.8),
        0 0 24px rgba(0, 0, 0, 0.6);
}
/* Ende WUNSCH 3 */


/* PERSISTENTES ERGEBNIS-OVERLAY IM GLASS-OPTIK */
.resultOverlay {
  max-width: 960px;
  margin: 0 auto; 
  background: rgba(255, 255, 255, 0.4); 
  backdrop-filter: blur(18px) saturate(200%); 
  -webkit-backdrop-filter: blur(18px) saturate(200%);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 16px;
  box-shadow: 
    0 6px 16px rgba(0, 0, 0, 0.3),
    0 12px 40px rgba(0, 0, 0, 0.25);
  
  padding: 12px 14px;
  color: var(--text);
  text-align: center;
  
  opacity: 0;
  max-height: 0;
  overflow: hidden; 
  margin-bottom: 0px; 
  margin-top: 0px; 
  position: relative; 

  transition: opacity 0.4s ease, max-height 0.4s ease, margin-top 0.4s ease, transform 0.4s ease, top 0.4s ease, width 0.4s ease;

  z-index: 50; 
  display: flex; 
  justify-content: space-between; 
  align-items: center; 
}

html[data-theme="dark"] .resultOverlay {
  background: rgba(0, 0, 0, 0.4);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

/* Zustand nach der Animation (Finale Position/Gr√∂√üe) */
.resultOverlay.show {
  opacity: 1;
  max-height: 200px; 
  margin-top: 24px; 
  margin-bottom: 70px; 
  transform: none; 
  top: auto;
  width: auto;
}

/* KLASSE f√ºr den Countdown-Zustand (zentral, gro√ü) */
.resultOverlay.floating {
    position: absolute; 
    top: 50%;
    left: 50%;
    transform: translate(-50%, -150%); 
    
    width: 90%; 
    max-width: 450px; 
    padding: 18px 20px; 
    
    opacity: 1;
    max-height: 200px;
    margin-top: 0;
    margin-bottom: 0;
    z-index: 50; 
}

/* Style der Elemente innerhalb der Floating Box */
.resultOverlay.floating div:first-child > div:last-child {
    font-size: 50px; 
}
.resultOverlay.floating div:last-child > div:last-child {
    font-size: 24px; 
}
/* Ende NEUE KLASSE */

/* NEUES ELEMENT: Live Throw Feedback (f√ºr Sprachverarbeitung) */
#liveThrowFeedback {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 90%;
    max-width: 300px;
    background: var(--feedback-bg);
    padding: 20px;
    border-radius: 16px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
    text-align: center;
    z-index: 200;
    display: none; /* Wird per JS gesteuert */
    border: 1px solid rgba(0, 0, 0, 0.1);
    pointer-events: none;
}
html[data-theme="dark"] #liveThrowFeedback {
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.throw-line {
    font-size: 40px;
    font-weight: 900;
    height: 50px; /* Platzhalter */
    line-height: 50px;
    color: var(--muted);
    transition: color 0.3s ease;
}

.throw-line.active {
    color: var(--mic-color-busy); /* Orange */
}

/* Readme Popover mit Glass-Design */
#readmePopover .modal {
    background: rgba(255, 255, 255, 0.7); 
    backdrop-filter: blur(8px) saturate(180%); 
    -webkit-backdrop-filter: blur(8px) saturate(180%);
    border: 1px solid rgba(255, 255, 255, 0.5);
    color: var(--text);
}
html[data-theme="dark"] #readmePopover .modal {
    background: rgba(0, 0, 0, 0.7);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: var(--dark-text);
}


/* Endgame Card (gleiche Breite und Form) */
.endcard{
  text-align:center;
  margin-top: 24px; 
  font-size:20px;
  font-weight:700;
  line-height:1.5;
  background: rgba(255, 255, 255, 0.7); 
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  border-radius: 16px; 
  padding: 12px 14px; 
  width: 100%; 
  max-width: 960px; 
  margin-left: auto;
  margin-right: auto;
  box-shadow: 0 8px 24px rgba(0,0,0,0.2);
  color: var(--text); 
  transition: opacity 0.3s;
}
html[data-theme="dark"] .endcard {
  background: rgba(0, 0, 0, 0.7); 
  color: var(--dark-text);
}
.endcard b {
  text-shadow: 0 0 3px rgba(255, 255, 255, 0.6), 0 0 6px rgba(255, 255, 255, 0.4);
}
html[data-theme="dark"] .endcard b {
  text-shadow: 0 0 3px rgba(0, 0, 0, 0.6), 0 0 6px rgba(0, 0, 0, 0.4);
}


@media (max-width:720px){ 
    .modal{width:92%} 
    .pauseCount{font-size:60px} 
    .btn{width:130px} 
    .resultOverlay.show {
        margin-bottom: 70px; 
        margin-top: 24px;
    } 
    #fixedHighscoreFooter {
        bottom: 70px; 
    }
}
</style>
</head>
<body>
<h1>Big-20 | Dart-Training</h1>
<span id="headlineSpacer"></span> 

<div class="scoreboard" id="scoreboard">
  <div><div>Restpunkte</div><div id="restBig">301</div></div>
  
  <div class="score-details">
    <div id="summary">Treffer: 0 von 0</div>
    <div id="qualityVal">Wurfqualit√§t: ‚Äì</div>
  </div>
</div>

<div id="liveThrowFeedback">
    <div style="font-size: 14px; font-weight: 500; color: var(--muted); margin-bottom: 8px;">Erkannte W√ºrfe</div>
    <div id="throw1" class="throw-line"></div>
    <div id="throw2" class="throw-line"></div>
    <div id="throw3" class="throw-line"></div>
</div>


<div id="board" aria-live="polite"></div>

<div id="resultOverlay" class="resultOverlay"></div>

<div id="fixedHighscoreFooter">
  <div id="headerHighscore">Highscore: -</div>
</div>

<div id="controls">
  <div id="micIcon" class="iconBtn mic-inactive" title="Spracheingabe starten/stoppen">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--mic-color-inactive)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="22"></line></svg>
  </div>
  
  <div id="gear" class="iconBtn" title="Einstellungen">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--gear-color)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3" stroke="none" fill="var(--gear-color)"></circle><path d="M12 22s8 0 8-8V10a8 8 0 0 0-8-8 8 8 0 0 0-8 8v4s0 8 8 8z" fill="none"></path><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82-.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0-.33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0 .33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H12a1.65 1.65 0 0 0 1.51-1V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V12a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
  </div>

  <div id="dartIcon" class="iconBtn" title="Informationen">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--dart-color)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M12 2a10 10 0 0 1 10 10 10 10 0 0 1-10 10 10 10 0 0 1-10-10 10 10 0 0 1 10-10z" fill="none"></path><circle cx="12" cy="12" r="6" stroke="var(--dart-color)" fill="none"></circle><circle cx="12" cy="12" r="2" stroke="var(--dart-color)" fill="var(--dart-color)"></circle></svg>
  </div>
  <div class="version" id="versionText">v3.25 Akkordeon & Live-Ansage</div>
</div>
<button id="newGame">Neues Spiel</button>

<div id="readmePopover" class="modalShade" style="z-index: 250;">
    <div class="modal" role="alert" aria-live="polite" style="max-width: 400px; text-align: center; cursor: pointer;">
        <p style="margin: 0; font-size: 16px; font-weight: 600;">Trainiere Triple-20-Treffer und versuche so m√∂glichst einen Scorewert von 100% zu erreichen. Es z√§hlen alle 20er-Treffer, sowie Bull und Bulls Eye. Alle anderen Treffer z√§hlen 0</p>
    </div>
</div>

<div id="pauseLayer" class="pauseLayer" aria-hidden="true">
  <div class="pauseShade"></div>
  <div class="pauseInfo" role="status" aria-live="polite">
    <div class="pauseCount" id="pauseCount">5</div>
  </div>
</div>
<div id="modalShade" class="modalShade" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
    <h2 id="settingsTitle">Einstellungen</h2>
    
    <h3 style="margin-top:12px;margin-bottom:6px">Eingabemodus</h3>
    <div class="twoCol" style="margin-bottom: 12px;">
        <label><input type="radio" name="inputMode" id="modeClick" value="click" checked> Manuell (Buttons)</label>
        <label><input type="radio" name="inputMode" id="modeVoice" value="voice"> Freih√§ndig (Sprache)</label>
    </div>

    <div class="row"><label><input type="checkbox" id="keepAwake"> Display-Timeout 5 Minuten verhindern</label></div>
    <div class="row"><label><input type="checkbox" id="darkModeToggle"> Darkmode (Always-On)</label></div>
    <div class="row"><label><input type="checkbox" id="speechToggle"> Sprachausgabe aktivieren (Score-Ansage)</label></div>
    
    <details>
        <summary>Sounds testen</summary>
        <div style="padding: 10px 14px 14px;">
            <div class="soundGrid" id="soundGrid"></div>
        </div>
    </details>
    
    <details>
        <summary>Sound-Zuweisungen</summary>
        <div style="padding: 10px 14px 14px;">
            <div class="twoCol">
              <div class="col-auto">
                <label>Triple-20<select id="sTriple"></select></label>
                <label>Doppel-20<select id="sDouble"></select></label>
                <label>Single-20<select id="sSingle"></select></label>
              </div>
              <div class="col-auto">
                <label>Bulls Eye<select id="sBullseye"></select></label>
                <label>Bull<select id="sBull"></select></label>
                <label>Null<select id="sZero"></select></label>
              </div>
            </div>
        </div>
    </details>
    
    <details>
        <summary>Daten & Highscore</summary>
        <div style="padding: 10px 14px 14px;">
            <button id="resetData" class="btn" style="width:auto;background:#e53935;">Highscore-Reset</button>
            <p class="small">L√∂scht Highscore aus dem Browser. Einstellungen (Darkmode, Sounds, Timeout) bleiben erhalten.</p>
        </div>
    </details>
    
    <div class="saveRow">
      <button id="saveSettings" class="btn">Speichern</button>
      <button id="closeSettings" class="btn" style="background:#ddd;color:#111">Schlie√üen</button>
    </div>
  </div>
</div>
<script>
/* Full v3.25 Akkordeon & Live-Ansage */
let score=301, throws=0, hits=0, qualitySum=0, roundThrows=0;
let lastThree=[], inPause=false, wakeLock=null;
let sectorCounts = {Triple: 0, Double: 0, Single: 0, Bullseye: 0, Bull: 0, Zero: 0};
let highscore = { quality: 0, hits: 0, throws: 0, avgQ: '‚Äì %' }; 
let speechEnabled = true; // Steuert die Sprachsynthese (Ausgabe)
let voiceModeEnabled = false; // NEU: Steuert den Voice-Only Mode

const restBig=document.getElementById('restBig'), summary=document.getElementById('summary'), qualityVal=document.getElementById('qualityVal'), board=document.getElementById('board');
const scoreboardEl=document.getElementById('scoreboard');
const highscoreEl=document.getElementById('headerHighscore'); 
const pauseLayer=document.getElementById('pauseLayer'), pauseCount=document.getElementById('pauseCount');
const resultOverlay=document.getElementById('resultOverlay'); 
const newGameBtn = document.getElementById('newGame');

const gear=document.getElementById('gear'), modalShade=document.getElementById('modalShade'), closeSettings=document.getElementById('closeSettings'), saveSettings=document.getElementById('saveSettings'), resetData=document.getElementById('resetData');
const keepAwake=document.getElementById('keepAwake'), darkModeToggle=document.getElementById('darkModeToggle'), speechToggle=document.getElementById('speechToggle');
const modeClick=document.getElementById('modeClick'), modeVoice=document.getElementById('modeVoice'); // NEU: Mode Radios

const soundGrid=document.getElementById('soundGrid'), sTriple=document.getElementById('sTriple'), sDouble=document.getElementById('sDouble'), sSingle=document.getElementById('sSingle'), sBullseye=document.getElementById('sBullseye'), sBull=document.getElementById('sBull'), sZero=document.getElementById('sZero');
const qualityMap={60:100,50:83.33,40:66.67,25:41.67,20:33.33,0:0};
const AudioContextClass = window.AudioContext || window.webkitAudioContext;
const audioCtx = new AudioContextClass();
const soundPresets=[
  {name:'Click 1',type:'sine',freq:800},{name:'Click 2',type:'sine',freq:1000},{name:'Pop',type:'square',freq:600},
  {name:'Beep',type:'sine',freq:1100},{name:'Tock',type:'triangle',freq:700},{name:'Ping',type:'sine',freq:1400},
  {name:'Blip',type:'square',freq:900},{name:'Clack',type:'triangle',freq:650},{name:'Ding',type:'sine',freq:1200},
  {name:'Tick',type:'square',freq:500},{name:'Zing',type:'sawtooth',freq:1500},{name:'Tone',type:'sine',freq:400}
];
let soundAssign={Triple:0,Double:1,Single:2,Bullseye:3,Bull:4,Zero:5};

// Readme Elemente
const dartIcon = document.getElementById('dartIcon');
const readmePopover = document.getElementById('readmePopover');

// NEUE SPEECH RECOGNITION VARIABLEN
const micIcon = document.getElementById('micIcon');
const liveThrowFeedback = document.getElementById('liveThrowFeedback'); // NEU: Live Feedback Element
const throwLines = [document.getElementById('throw1'), document.getElementById('throw2'), document.getElementById('throw3')];
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognition = null; 
let isRecognizing = false;
let isGameStarted = false; 
let wasRecognitionError = false; 

// **********************************************
// Speech Recognition Logik
// **********************************************

function setupSpeechRecognition() {
    if (!SpeechRecognition) {
        console.warn("Speech Recognition API nicht verf√ºgbar.");
        micIcon.style.display = 'none';
        return;
    }
    
    recognition = new SpeechRecognition();
    recognition.continuous = true; 
    recognition.interimResults = false;
    recognition.lang = 'de-DE'; 

    recognition.onstart = () => {
        isRecognizing = true;
        wasRecognitionError = false; 
        micIcon.classList.remove('mic-inactive', 'mic-busy');
        micIcon.classList.add('mic-active');
        console.log('Spracherkennung gestartet. H√∂re zu...');
    };

    recognition.onend = () => {
        isRecognizing = false;
        micIcon.classList.remove('mic-active', 'mic-busy');
        micIcon.classList.add('mic-inactive');
        liveThrowFeedback.style.display = 'none'; // Feedback-Anzeige ausblenden
        console.log('Spracherkennung beendet.');
        
        // Auto-Restart Logik
        if (isGameStarted && score > 0 && !wasRecognitionError && voiceModeEnabled) { // Nur im Voice Mode
            console.log('Versuch des Auto-Restarts...');
            setTimeout(startSpeechRecognition, 500);
        } else if (wasRecognitionError) {
             console.log('Auto-Restart wegen Fehler in der letzten Sitzung blockiert.');
        }
    };
    
    recognition.onerror = (event) => {
        console.error('Spracherkennungsfehler:', event.error);
        wasRecognitionError = true; 
        
        if (event.error === 'not-allowed') {
             alert('Mikrofonzugriff verweigert oder blockiert. Bitte erneut auf das üéôÔ∏è-Symbol klicken, um die Berechtigung zu erteilen.');
        }
        
        if (isRecognizing) recognition.stop(); 
    };

    recognition.onresult = (event) => {
        if (inPause || score === 0 || !isGameStarted || !voiceModeEnabled) return; // Nur im Voice Mode verarbeiten

        const transcript = event.results[event.results.length - 1][0].transcript.toLowerCase().trim();
        handleSpeechResult(transcript);
    };
}

function startSpeechRecognition() {
    if (!recognition) return;
    if (isRecognizing) return;
    try {
        wasRecognitionError = false; 
        recognition.start();
    } catch (e) {
        console.warn("Fehler beim Starten der Erkennung:", e.message);
        isRecognizing = false;
        micIcon.classList.remove('mic-active', 'mic-busy');
        micIcon.classList.add('mic-inactive');
        wasRecognitionError = true; 
    }
}

function stopSpeechRecognition() {
    if (recognition && isRecognizing) {
        recognition.stop();
    }
}

// NEU: Erweiterte Mapping-Logik
const dartRecognitionMapping = {
    // Numerische Werte
    'null': {points: 0, assign: 'Zero', speak: 'null'}, '0': {points: 0, assign: 'Zero', speak: 'null'},
    'zwanzig': {points: 20, assign: 'Single', speak: 'zwanzig'}, '20': {points: 20, assign: 'Single', speak: 'zwanzig'},
    'vierzig': {points: 40, assign: 'Double', speak: 'vierzig'}, '40': {points: 40, assign: 'Double', speak: 'vierzig'},
    'sechzig': {points: 60, assign: 'Triple', speak: 'sechzig'}, '60': {points: 60, assign: 'Triple', speak: 'sechzig'},
    'f√ºnfundzwanzig': {points: 25, assign: 'Bull', speak: 'f√ºnfundzwanzig'}, '25': {points: 25, assign: 'Bull', speak: 'f√ºnfundzwanzig'},
    'f√ºnfzig': {points: 50, assign: 'Bullseye', speak: 'f√ºnfzig'}, '50': {points: 50, assign: 'Bullseye', speak: 'f√ºnfzig'},

    // Deskriptive Namen (h√∂here Priorit√§t)
    'triple zwanzig': {points: 60, assign: 'Triple', speak: 'sechzig'},
    'doppel zwanzig': {points: 40, assign: 'Double', speak: 'vierzig'},
    'single zwanzig': {points: 20, assign: 'Single', speak: 'zwanzig'},
    'bull': {points: 25, assign: 'Bull', speak: 'f√ºnfundzwanzig'},
    'bullseye': {points: 50, assign: 'Bullseye', speak: 'f√ºnfzig'},
    'single': {points: 20, assign: 'Single', speak: 'zwanzig'},
    'doppel': {points: 40, assign: 'Double', speak: 'vierzig'},
    'triple': {points: 60, assign: 'Triple', speak: 'sechzig'},
};

function handleSpeechResult(transcript) {
    console.log("Erkannt:", transcript);
    
    if (!transcript.startsWith('plus')) return;

    let numbersString = transcript.replace('plus', '').trim();
    
    // 2. Erkannten Text in eine Zahlensequenz umwandeln (inkl. deskriptiver Namen)
    const words = numbersString.split(/\s+/).filter(w => w.length > 0);
    let parsedThrows = [];
    let i = 0;
    
    while (i < words.length) {
        let matched = null;
        let matchLength = 0;

        // Versuche, 2-Wort-Kombinationen zu matchen (z.B. "triple zwanzig")
        if (i + 1 < words.length) {
            const twoWords = words[i] + ' ' + words[i+1];
            if (dartRecognitionMapping[twoWords]) {
                matched = dartRecognitionMapping[twoWords];
                matchLength = 2;
            }
        }
        
        // Versuche, 1-Wort-Matches zu finden (oder wenn 2-Wort-Match fehlschl√§gt)
        if (!matched) {
            if (dartRecognitionMapping[words[i]]) {
                matched = dartRecognitionMapping[words[i]];
                matchLength = 1;
            } else {
                // Versuche, numerische Ziffern (z.B. '60') zu parsen
                const num = parseInt(words[i]);
                // Finde den Eintrag, der zum erkannten numerischen Wert passt (z.B. 60 -> Triple)
                const numericMatch = Object.values(dartRecognitionMapping).find(m => m.points === num && !m.assign.startsWith('Bull'));
                if (!isNaN(num) && numericMatch) {
                    matched = numericMatch;
                    matchLength = 1;
                }
            }
        }
        
        if (matched) {
            parsedThrows.push(matched);
            i += matchLength;
        } else {
            i++; // Wort √ºberspringen, wenn es nicht gematcht werden kann
        }
    }

    // 3. Auf 3 W√ºrfe pr√ºfen
    if (parsedThrows.length === 0 || parsedThrows.length > 3) {
        // Bei Ung√ºltigkeit Feedback kurz anzeigen und dann ausblenden
        micIcon.classList.add('mic-busy');
        liveThrowFeedback.style.display = 'block';
        throwLines.forEach(el => el.textContent = '');
        throwLines[0].textContent = 'Ung√ºltige Eingabe';
        setTimeout(() => { 
            liveThrowFeedback.style.display = 'none';
            micIcon.classList.remove('mic-busy');
        }, 1500);
        return;
    }

    // 4. Visuelles Feedback f√ºr die Verarbeitung starten
    micIcon.classList.add('mic-busy');
    liveThrowFeedback.style.display = 'block';
    
    // Initiales Anzeigen aller erkannten Werte, aber inaktiv
    throwLines.forEach((el, idx) => {
        el.textContent = parsedThrows[idx] ? parsedThrows[idx].points.toString() : '';
        el.classList.remove('active');
    });

    // 5. W√ºrfe nacheinander verarbeiten
    let processedThrows = 0;
    
    function processNextThrow() {
        if (processedThrows >= parsedThrows.length || score === 0) {
            micIcon.classList.remove('mic-busy'); // Verarbeitung beendet
            setTimeout(() => liveThrowFeedback.style.display = 'none', 500);
            return;
        }

        const throwData = parsedThrows[processedThrows];
        const currentLine = throwLines[processedThrows];
        
        // A. Visuelles Update: Aktuellen Wurf hervorheben
        currentLine.classList.add('active');

        // B. Akustisches Update: Wert ansagen
        if (speechEnabled) {
             speak(cleanSpoken(throwData.speak));
        }

        // C. Scoring-Logik ausf√ºhren
        scoring(throwData.points, throwData.assign, throwData.assign); 
        
        processedThrows++;
        
        // D. Verz√∂gerung, um die Ansage und das visuelle Feedback zu integrieren
        setTimeout(() => {
            currentLine.classList.remove('active');
            processNextThrow();
        }, 1200); // 1.2s Pause f√ºr Ansage + Puffer
    }
    
    // Starte nach einer kurzen optischen Pause
    setTimeout(processNextThrow, 300); 
}


// **********************************************
// Einstellungs-Logik 
// **********************************************
function loadSettings(){ 
    try{ 
        const s=JSON.parse(localStorage.getItem('big20_settings')||'{}'); 
        if(s.soundAssign) soundAssign=s.soundAssign; 
        
        speechEnabled = s.speechEnabled !== undefined ? s.speechEnabled : true;
        speechToggle.checked = speechEnabled;
        
        // NEU: Lade Voice Mode
        voiceModeEnabled = s.voiceModeEnabled !== undefined ? s.voiceModeEnabled : false; 
        updateModeUI();

        if(s.darkMode){ 
            document.documentElement.setAttribute('data-theme','dark'); 
            darkModeToggle.checked=true;
        } else { 
            document.documentElement.removeAttribute('data-theme');
            darkModeToggle.checked=false;
        }
        
        if(s.keepAwake){ 
            keepAwake.checked=true; 
            requestWakeLock(); 
        } else {
            keepAwake.checked=false;
            releaseWakeLock();
        }

    }catch(e){console.warn(e);} 
}

function updateModeUI() {
    // 1. Radio Buttons setzen
    modeVoice.checked = voiceModeEnabled;
    modeClick.checked = !voiceModeEnabled;
    
    // 2. UI an Modus anpassen (Buttons, Scoreboard Style, NewGame Position)
    if (voiceModeEnabled) {
        board.style.opacity = '0';
        board.style.height = '0';
        newGameBtn.style.opacity = '0';
        newGameBtn.style.pointerEvents = 'none';
        scoreboardEl.classList.add('voice-mode');
        micIcon.style.display = 'flex';
        // Wenn das Spiel l√§uft, starte die Erkennung, um continuous zu sein
        if(isGameStarted && score > 0) startSpeechRecognition();
    } else {
        board.style.opacity = '1';
        board.style.height = 'auto';
        newGameBtn.style.opacity = '1';
        newGameBtn.style.pointerEvents = 'auto';
        scoreboardEl.classList.remove('voice-mode');
        micIcon.style.display = 'none'; // Mic Icon nur im Voice Mode
        stopSpeechRecognition(); // Im Click Mode Mikrofon stoppen
    }
}

function saveSettingsToStore(){ 
    speechEnabled = speechToggle.checked; 
    voiceModeEnabled = modeVoice.checked; // NEU: Speichere Modus

    const obj={
        soundAssign, 
        darkMode: !!darkModeToggle.checked, 
        keepAwake: !!keepAwake.checked,
        speechEnabled: speechEnabled,
        voiceModeEnabled: voiceModeEnabled
    }; 
    localStorage.setItem('big20_settings', JSON.stringify(obj)); 
}


// **********************************************
// RESTLICHE LOGIK (Sound, UI, Spiel)
// **********************************************
function updateUI(){ 
    restBig.textContent=score; 
    summary.textContent='Treffer: '+hits+' von '+throws; 
    qualityVal.textContent=computeQualityDisplay(); 
    updateHighscoreUI(); 
    updateModeUI(); // Stellt sicher, dass das UI auch im Spiel richtig ist (z.B. Score < 0)
} 

function renderBoard(){ 
    if (voiceModeEnabled) {
        board.innerHTML = '<div class="endcard" style="opacity:0.8; margin-top:0;">Der Voice-Mode ist aktiv. Bitte starten Sie ein neues Spiel und sagen Sie dann "plus 60 40 0".</div>';
        return;
    }
    
    // Bestehende Click Mode Logik
    board.innerHTML=''; 
    if(score===0){ return; } 
    if(inPause) { return; }

    if(score<20){ renderUnder20Centered(score); return; } const tripleDis=(score<=59), beDis=(score<=49), doubleDis=(score<=39), bullDis=(score<=24); const left=document.createElement('div'); left.className='col'; const right=document.createElement('div'); right.className='col'; const leftBtns=[{t:'Triple-20',v:60,d:tripleDis,assign:'Triple'},{t:'Doppel-20',v:40,d:doubleDis,assign:'Double'},{t:'Single-20',v:20,d:false,assign:'Single'}]; const rightBtns=[{t:'Bulls Eye',v:50,d:beDis,assign:'Bullseye'},{t:'Bull',v:25,d:bullDis,assign:'Bull'},{t:'Null',v:0,d:false,assign:'Zero'}]; leftBtns.forEach(b=>{ const el=document.createElement('button'); el.className='btn'; el.textContent=b.t; el.disabled=b.d; el.onclick=()=>handleClick(el,b.v,b.t,b.assign); left.appendChild(el); }); rightBtns.forEach(b=>{ const el=document.createElement('button'); el.className='btn'; el.textContent=b.t; el.disabled=b.d; el.onclick=()=>handleClick(el,b.v,b.t,b.assign); right.appendChild(el); }); board.appendChild(left); board.appendChild(right); 
}
function renderUnder20Centered(s){ board.innerHTML=''; const col=document.createElement('div'); col.className='undercol'; function add(label,val,assign){ const b=document.createElement('button'); b.className='btn'; b.textContent=label; b.onclick=()=>handleClick(b,val,label,assign); col.appendChild(b); } if(s===19) add('19',19,'Single'); else if(s===18){ add('Triple-6',18,'Triple'); add('Doppel-9',18,'Double'); add('18',18,'Single'); } else if(s===17) add('17',17,'Single'); else if(s===16){ add('Doppel-8',16,'Double'); add('16',16,'Single'); } else if(s===15){ add('Triple-5',15,'Triple'); add('15',15,'Single'); } else if(s===14){ add('Doppel-7',14,'Double'); add('14',14,'Single'); } else if(s===13) add('13',13,'Single'); else if(s===12){ add('Triple-4',12,'Triple'); add('Doppel-6',12,'Double'); add('12',12,'Single'); } else if(s===11) add('11',11,'Single'); else if(s===10){ add('Doppel-5',10,'Double'); add('10',10,'Single'); } else if(s===9){ add('Triple-3',9,'Triple'); add('9',9,'Single'); } else if(s===8){ add('Doppel-4',8,'Double'); add('8',8,'Single'); } else if(s===7) add('7',7,'Single'); else if(s===6){ add('Triple-2',6,'Triple'); add('Doppel-3',6,'Double'); add('6',6,'Single'); } else if(s===5) add('5',5,'Single'); else if(s===4){ add('Doppel-2',4,'Double'); add('4',4,'Single'); } else if(s===3){ add('Triple-1',3,'Triple'); add('3',3,'Single'); } else if(s===2){ add('Doppel-1',2,'Double'); add('2',2,'Single'); } else if(s===1) add('1',1,'Single'); add('Null',0,'Zero'); board.appendChild(col); }

function handleClick(btnEl, points, label, assignKey) {
    if (inPause) return;
    const isHit = points > 0;
    
    // Tempor√§res visuelles Feedback (wie in v3.23)
    btnEl.style.transition = "background-color 0.15s ease";
    btnEl.style.backgroundColor = isHit ? "rgba(0,255,0,0.6)" : "rgba(255,0,0,0.6)";
    setTimeout(() => { btnEl.style.backgroundColor = ""; }, 200);
    if (navigator.vibrate) navigator.vibrate(30);
    flashVisual(btnEl, isHit);

    const idx = soundAssign[assignKey] !== undefined ? soundAssign[assignKey] : 0;
    playSound(idx);

    scoring(points, label, assignKey);
}
// Unver√§nderte Funktionen (playSound, cleanSpoken, requestWakeLock, etc.)
function buildSoundUI(){ soundGrid.innerHTML=''; soundPresets.forEach((s,i)=>{ const b=document.createElement('button'); b.className='soundBtn'; b.textContent=s.name; b.onclick=()=>playSound(i); soundGrid.appendChild(b); [sTriple,sDouble,sSingle,sBullseye,sBull,sZero].forEach(sel=>{ const opt=document.createElement('option'); opt.value=i; opt.textContent=s.name; sel.appendChild(opt); }); }); sTriple.value=soundAssign.Triple; sDouble.value=soundAssign.Double; sSingle.value=soundAssign.Single; sBullseye.value=soundAssign.Bullseye; sBull.value=soundAssign.Bull; sZero.value=soundAssign.Zero; }
function playSound(index){ try{ const p=soundPresets[index]; if(!p) return; const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type=p.type; o.frequency.value=p.freq; g.gain.value=0.0001; o.connect(g); g.connect(audioCtx.destination); const now=audioCtx.currentTime; g.gain.setValueAtTime(0.0001,now); g.gain.exponentialRampToValueAtTime(0.18, now+0.005); o.start(now); g.gain.exponentialRampToValueAtTime(0.0001, now+0.18); o.stop(now+0.21); }catch(e){console.warn('audio err',e);} }
function chooseGermanVoice(){ if(typeof speechSynthesis==='undefined') return null; const voices=speechSynthesis.getVoices(); const maleNames=/(Markus|Michael|Thomas|Peter|Hans|Jan|Mark|David|Daniel|Andreas|Mann|Male|Herr)/i; let v=voices.find(x=>x.lang&&x.lang.startsWith('de')&&maleNames.test(x.name)); if(!v) v=voices.find(x=>x.lang&&x.lang.startsWith('de')); return v||null; }
function speak(text){ if(!speechEnabled||typeof speechSynthesis==='undefined') return; try{ const v=chooseGermanVoice(); const msg=new SpeechSynthesisUtterance(text); if(v) msg.voice=v; msg.lang='de-DE'; msg.rate=1; msg.pitch=1; speechSynthesis.cancel(); speechSynthesis.speak(msg); }catch(e){console.warn('speech',e);} }
function computeQualityDisplay(){ if(throws===0) return 'Wurfqualit√§t: ‚Äì'; return 'Wurfqualit√§t: '+Math.round(qualitySum/throws)+' %'; }
function flashVisual(el,hit){ el.classList.remove('flash-green','flash-red'); void el.offsetWidth; el.classList.add(hit?'flash-green':'flash-red'); setTimeout(()=>{ el.classList.remove('flash-green','flash-red'); },460); }
function scoring(points,label,assignKey){ 
  
  if (roundThrows === 0) { 
      resultOverlay.classList.remove('show', 'floating');
  }

  throws++; roundThrows++; 
  if(sectorCounts.hasOwnProperty(assignKey)){
      sectorCounts[assignKey]++;
  }

  const potential = score - points; 
  const bust = (potential < 0); 
  
  if(bust){ 
    qualitySum += qualityMap[0]; 
    lastThree.push({label:label,points:0,q:0}); 
    if(lastThree.length>3) lastThree.shift(); 
    updateUI(); 
    checkPause(); 
    return; 
  } 
  
  if(points>0) hits++; 
  score = potential; 
  let q = (qualityMap[points]!==undefined)? qualityMap[points]:0; 
  if(score===0) q=100; 
  qualitySum += q; 
  lastThree.push({label:label,points:points,q: Math.round(q)}); 
  if(lastThree.length>3) lastThree.shift(); 
  updateUI(); 
  
  if(score===0){ 
    renderBoard(); 
    announceEnd(); 
    return; 
  } 
  checkPause(); 
}
function checkPause(){ 
    if(roundThrows>=3){ 
        roundThrows=0; 
        startPause(); 
    } else { 
        renderBoard(); 
    } 
}
function startPause(){ 
  inPause=true; 
  
  // 1. Pause Layer (Hintergrund und Countdown) anzeigen
  pauseLayer.style.display='flex'; 
  pauseLayer.setAttribute('aria-hidden','false'); 
  
  const arr=lastThree.slice(-3); 
  const totalPoints = arr.reduce((sum, x) => sum + (x.points || 0), 0);
  const roundHits = arr.filter(x => x.points > 0).length;
  const avg = arr.length>0? Math.round(arr.reduce((s,x)=>s+(x.q||0),0)/arr.length):0; 
  const scoreColor = (totalPoints>0)?'var(--good)':'var(--bad)';
  
  // 2. Persistent Overlay direkt im Floating Zustand anzeigen
  resultOverlay.innerHTML = `
    <div>
        <div style="color: var(--muted);">Punktzahl zuletzt</div>
        <div style="font-size: 44px; font-weight: 900; color: ${scoreColor}; margin: 6px 0;">${totalPoints}</div>
    </div>
    <div style="text-align:right;">
        <div style="display: block; font-size: 13px; font-weight: 500; margin-top: 4px; color: var(--muted);">${roundHits} Treffer</div>
        <div style="font-size: 20px; font-weight: 800; margin-top: 6px;">Wurfqualit√§t: ${avg} %</div>
    </div>
  `;
  // Box wird sichtbar und erh√§lt die zentrale/gro√üe Position
  resultOverlay.classList.remove('show');
  resultOverlay.classList.add('floating');
  
  // WUNSCH ERF√úLLT: Restpunkte ansagen
  if(speechEnabled){ 
    // Der Code muss sicherstellen, dass hier nicht die Einzelansage von processNextThrow dazwischenfunkt.
    // Da startPause() erst nach Beendigung von processNextThrow() aufgerufen wird, ist das hier sicher.
    const spoken = `${totalPoints} Punkte, Scorewert ${avg} Prozent. Rest ${score}`; 
    speak(cleanSpoken(spoken)); 
  } 
  
  let t=5; 
  pauseCount.textContent=t; 
  const iv=setInterval(()=>{ 
    t--; 
    pauseCount.textContent=t; 
    if(t<=0){ 
      clearInterval(iv); 
      endPause(); 
    } 
  },1000);
}

function endPause(){ 
    inPause=false; 
    
    // 1. Box wird JETZT in die finale (obere) Position animiert
    resultOverlay.classList.remove('floating'); 
    resultOverlay.classList.add('show');       

    // 2. Pause Layer (Hintergrund und Countdown) ausblenden
    pauseLayer.style.display='none'; 
    pauseLayer.setAttribute('aria-hidden','true');
    
    // 3. Board muss neu gerendert werden
    renderBoard(); 
}

function announceEnd(){ 
    stopSpeechRecognition();
    
    const finalAvg = throws>0?Math.round(qualitySum/throws):0; 
    const finalHits = hits;
    const finalThrows = throws;
    const finalAvgStr = finalAvg + ' %';
    
    const isNewHighscore = saveHighscore(finalAvg, finalHits, finalThrows, finalAvgStr);

    isGameStarted = false;

    pauseLayer.style.display='none'; 
    pauseLayer.setAttribute('aria-hidden','true'); 
    resultOverlay.classList.remove('show', 'floating'); 

    board.innerHTML=''; 
    const card=document.createElement('div'); 
    card.className='endcard'; 
    card.innerHTML = `üéØ <b>Spiel beendet!</b><br><br>${finalHits} Treffer von ${finalThrows} W√ºrfen<br>Wurfqualit√§t: ${finalAvg} %`;
    
    if (isNewHighscore) {
        card.innerHTML += '<br><br>üéâ **NEUER HIGHSCORE!**';
    }

    board.appendChild(card); 
    speak(cleanSpoken(`Spiel beendet. Treffer: ${finalHits} von ${finalThrows}. Wurfqualit√§t: ${finalAvg} Prozent.`)); 
    
    sectorCounts = {Triple: 0, Double: 0, Single: 0, Bullseye: 0, Bull: 0, Zero: 0};
}
function cleanSpoken(s){ let out=s.replace(/‚Äì/g,' | '); out = out.replace(/minus\s*/ig,' '); return out; }
function requestWakeLock(){ try{ if('wakeLock' in navigator){ navigator.wakeLock.request('screen').then(wl=>{ wakeLock=wl; wl.addEventListener('release',()=>{ wakeLock=null; }); }).catch(e=>console.warn('wake lock request failed',e)); } }catch(e){console.warn(e);} }
function releaseWakeLock(){ try{ if(wakeLock){ wakeLock.release().catch(()=>{}); wakeLock=null; } }catch(e){console.warn(e);} }
if(typeof speechSynthesis!=='undefined'){ speechSynthesis.onvoiceschanged = ()=>{}; }
function getTopThreeSectors(counts) {const sectorArray = Object.keys(counts).map(key => ({label: key === 'Zero' ? '0' : key.replace(/Triple|Double|Single/, (m) => {if(m === 'Triple') return 'Triple-20';if(m === 'Double') return 'Doppel-20';if(m === 'Single') return '20'; return m;}),count: counts[key]}));sectorArray.sort((a, b) => b.count - a.count);const topThree = sectorArray.slice(0, 3).filter(s => s.count > 0);if (topThree.length === 0) return '‚Äì | ‚Äì | ‚Äì';const labels = topThree.map(s => s.label);while (labels.length < 3) {labels.push('‚Äì');}return labels.join(' | ');}
function loadHighscore(){try{const hs = JSON.parse(localStorage.getItem('big20_highscore') || '{}');highscore = { quality: 0, hits: 0, throws: 0, avgQ: '‚Äì %', topThreeSectors: '‚Äì | ‚Äì | ‚Äì' };if (hs.quality !== undefined && (parseInt(hs.quality) > 0 || parseInt(hs.hits) > 0)) {highscore.quality = parseInt(hs.quality) || 0;highscore.hits = parseInt(hs.hits) || 0;highscore.throws = parseInt(hs.throws) || 0;highscore.avgQ = hs.avgQ || '‚Äì %';highscore.topThreeSectors = hs.topThreeSectors || '‚Äì | ‚Äì | ‚Äì';}} catch(e) {console.warn('Highscore konnte nicht geladen werden', e);}updateHighscoreUI();}
function saveHighscore(finalQuality, finalHits, finalThrows, finalAvgString){const topThreeSectorsString = getTopThreeSectors(sectorCounts);if (finalQuality > highscore.quality || (highscore.quality === 0 && finalQuality > 0)) {highscore.quality = finalQuality;highscore.hits = finalHits;highscore.throws = finalThrows;highscore.avgQ = finalAvgString;highscore.topThreeSectors = topThreeSectorsString;localStorage.setItem('big20_highscore', JSON.stringify(highscore));updateHighscoreUI();return true;}return false;}
function updateHighscoreUI(){const quality = highscore.quality || 0;const hits = highscore.hits || 0;const throws = highscore.throws || 0;const topThree = highscore.topThreeSectors || '‚Äì | ‚Äì | ‚Äì';highscoreEl.innerHTML = `Highscore: ${quality} % | ${hits} Treffer von ${throws} <br> Top 3: ${topThree}`;}
function resetAllData() {if (confirm('Sind Sie sicher, dass Sie den gespeicherten Highscore l√∂schen m√∂chten?')) {localStorage.removeItem('big20_highscore');loadHighscore();alert('Der Highscore wurde gel√∂scht.');document.getElementById('modalShade').style.display='none'; document.getElementById('modalShade').setAttribute('aria-hidden','true');}}


// **********************************************
// EVENT HANDLER
// **********************************************

document.getElementById('saveSettings').onclick = ()=>{ 
    soundAssign = {
        Triple: parseInt(sTriple.value), Double: parseInt(sDouble.value), Single: parseInt(sSingle.value), 
        Bullseye: parseInt(sBullseye.value), Bull: parseInt(sBull.value), Zero: parseInt(sZero.value)
    }; 
    
    if(darkModeToggle.checked){ document.documentElement.setAttribute('data-theme','dark'); } 
    else { document.documentElement.removeAttribute('data-theme'); }

    if(keepAwake.checked) requestWakeLock(); else releaseWakeLock(); 
    
    voiceModeEnabled = modeVoice.checked; // Lese den neuen Modus
    updateModeUI(); // UI sofort anpassen

    saveSettingsToStore(); 
    document.getElementById('modalShade').style.display='none'; 
    document.getElementById('modalShade').setAttribute('aria-hidden','true'); 
};

resetData.onclick = resetAllData;

// Gear Icon
document.getElementById('gear').onclick = ()=>{ 
    readmePopover.style.display='none'; // Close readme if open
    // Vor dem √ñffnen den aktuellen Modus setzen
    modeVoice.checked = voiceModeEnabled;
    modeClick.checked = !voiceModeEnabled;
    
    document.getElementById('modalShade').style.display='flex'; 
    document.getElementById('modalShade').setAttribute('aria-hidden','false'); 
};

// Dart Icon / Readme Popover Logic (unver√§ndert)
dartIcon.onclick = (e) => {
    e.stopPropagation(); 
    document.getElementById('modalShade').style.display='none'; // Close settings if open
    document.getElementById('modalShade').setAttribute('aria-hidden','true');
    
    // Toggle Readme Popover
    if (readmePopover.style.display === 'flex') {
        readmePopover.style.display = 'none';
        readmePopover.setAttribute('aria-hidden', 'true');
    } else {
        readmePopover.style.display = 'flex';
        readmePopover.setAttribute('aria-hidden', 'false');
    }
};

// Mikrofon Icon (Manueller Start/Stopp - nur relevant im Voice Mode)
micIcon.onclick = (e) => {
    e.stopPropagation(); 
    
    if (!voiceModeEnabled) return; // Funktioniert nur im Voice Mode
    
    if (!isGameStarted || score === 0) { 
        alert('Bitte starten Sie zuerst ein neues Spiel √ºber den "Neues Spiel" Button.');
        return;
    }

    if (recognition && !isRecognizing) {
        startSpeechRecognition(); 
    } else if (recognition && isRecognizing) {
        stopSpeechRecognition(); 
    }
};

// Readme Popover Hide on Click Anywhere
readmePopover.onclick = () => {
    readmePopover.style.display = 'none';
    readmePopover.setAttribute('aria-hidden', 'true');
};

document.getElementById('closeSettings').onclick = ()=>{ document.getElementById('modalShade').style.display='none'; document.getElementById('modalShade').setAttribute('aria-hidden','true'); loadSettings(); };

// WICHTIG: "Neues Spiel" Button startet jetzt das Spiel und ggf. die Spracherkennung
document.getElementById('newGame').onclick = ()=>{ 
    score=301; throws=0; hits=0; qualitySum=0; roundThrows=0; 
    lastThree=[]; inPause=false; 
    sectorCounts = {Triple: 0, Double: 0, Single: 0, Bullseye: 0, Bull: 0, Zero: 0}; 
    document.getElementById('pauseLayer').style.display='none'; 
    resultOverlay.classList.remove('show', 'floating'); 
    liveThrowFeedback.style.display = 'none'; // Live Feedback immer ausblenden

    isGameStarted = true;
    stopSpeechRecognition(); // Stellt sicher, dass alte Sitzungen beendet werden
    
    // Starte Spracherkennung automatisch, wenn im Voice Mode
    if (voiceModeEnabled) {
        startSpeechRecognition();
        console.log('Spiel und Spracherkennung gestartet.');
        
        // Initialer Hinweis f√ºr den Voice Mode
        board.innerHTML = '<div class="endcard" style="opacity:0.8; margin-top:0;">Sagen Sie "plus [Wert] [Wert] [Wert]" (z.B. "plus 60 40 0").</div>';
    } else {
        console.log('Spiel gestartet. Eingabe √ºber Buttons.');
    }
    
    updateUI(); // UI muss den neuen Score und Modus zeigen
    renderBoard(); 
};

// **********************************************
// INITIALISIERUNG
// **********************************************
setupSpeechRecognition(); 
buildSoundUI(); 
loadHighscore(); 
loadSettings(); 
// renderBoard wird von loadSettings/updateModeUI aufgerufen.
</script>
</body>
</html>
