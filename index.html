<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Dartâ€‘Trainer (v3.29 Multi-Player)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  /* -------------------- Globale Variablen (fÃ¼r Darkmode) -------------------- */
  :root{
    --bg:#f5f7fb; --card:#fff; --text:#111; --muted:#666; --accent:#2979ff; --good:#1fa64a; --bad:#d22;
    --dark-bg:#000; --dark-card:#0b0b0b; --dark-text:#eaeaea; --dark-muted:#9a9a9a;
    --gear-color: #fdd835; 
    --dart-color: #e53935; 
    --mic-color-active: #1fa64a; 
    --mic-color-inactive: #666; 
    --mic-color-busy: #ff9800; 
    --feedback-bg: rgba(255, 255, 255, 0.9);
    --player1-color: #2979ff; /* Blau */
    --player2-color: #e53935; /* Rot */
  }
  html[data-theme="dark"]{ 
      --bg:var(--dark-bg); --card:var(--dark-card); --text:var(--dark-text); --muted:var(--dark-muted); 
      --feedback-bg: rgba(0, 0, 0, 0.9);
  }

  /* -------------------- BODY / Hintergrundbild -------------------- */
  body{
      margin:0;padding:18px;font-family:Inter,Arial,sans-serif;
      /* Aktualisierter Pfad fÃ¼r den Hintergrund, falls das Bild nicht lokal gefunden wird */
      background: var(--bg) url("https://raw.githubusercontent.com/unheimlicht/Big20/refs/heads/main/20251109_194725-COLLAGE%7E7.jpg") no-repeat center center fixed; 
      background-size: cover; 
      background-color: #000; 
      color:var(--text);-webkit-font-smoothing:antialiased;
      transition: background-color 0.3s;
      min-height: 100vh;
      box-sizing: border-box;
  }
  html[data-theme="dark"] body { 
      background: var(--dark-bg);
      background-image: none !important;
  }

  /* -------------------- Optische Verbesserungen -------------------- */
  h1 { text-shadow: 0 0 6px rgba(255, 255, 255, 0.8), 0 0 12px rgba(255, 255, 255, 0.6); letter-spacing: 0.5px; text-align:center; margin:8px 0 0; font-size:20px }
  #headlineSpacer { height: 12px; display: block; }
  
  /* NEU: Multi-Player Scoreboard */
  .scoreboard{
      display:grid; 
      grid-template-columns: 1fr auto 1fr; /* Links, Mitte (Infos), Rechts */
      align-items:center;
      background: rgba(255, 255, 255, 0.4); 
      backdrop-filter: blur(18px) saturate(200%); 
      -webkit-backdrop-filter: blur(18px) saturate(200%);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 16px;
      max-width:960px;margin:0 auto 12px;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3), 0 12px 40px rgba(0, 0, 0, 0.25);
      padding:12px 14px;
      gap: 10px; /* Abstand zwischen den Spalten */
  }
  .player-score-box { text-align: center; }
  .player-score-box #restBig { margin: 0; font-size: 38px; }
  .player-score-box .player-name { font-size: 14px; font-weight: 600; margin-top: 4px; color: var(--muted); }
  .player-score-box.active { 
    transform: scale(1.05); 
    border-radius: 10px;
    padding: 5px;
    background: rgba(255, 255, 255, 0.2);
    box-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
    transition: all 0.3s ease;
  }
  html[data-theme="dark"] .player-score-box.active {
    background: rgba(0, 0, 0, 0.2);
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.8);
  }
  .player-score-box.active .player-name { 
    color: var(--text); 
  }
  #p1ScoreBox.active .player-name { color: var(--player1-color); }
  #p2ScoreBox.active .player-name { color: var(--player2-color); }

  .game-details { text-align:center; }
  .game-details #summary { display: block; font-size:13px; font-weight:500; margin-top:4px; color: var(--muted); } 
  .game-details #qualityVal { font-size:20px; font-weight:800; margin-top:6px; }

  /* Single-Player Scoreboard (Fallback/Initial State) */
  .scoreboard.single-player {
    display: flex;
    justify-content: space-between;
  }
  .scoreboard.single-player .player-score-box:last-child { display: none; }
  .scoreboard.single-player .player-score-box:first-child { text-align: left; }

  /* -------------------- Buttons & Highscore -------------------- */
  .btn { width:150px;padding:12px;margin:6px;border-radius:10px;border:0;background:var(--accent);color:#fff;font-size:16px;cursor:pointer; box-shadow: 0 8px 18px rgba(0, 0, 0, 0.4); transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.15s ease; }
  .btn:hover { transform: translateY(-3px); box-shadow: 0 12px 24px rgba(0, 0, 0, 0.4), 0 4px 10px rgba(0, 128, 255, 0.4); }
  .btn:active { transform: translateY(1px) scale(0.97); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); }
  .btn:disabled{opacity:.5;cursor:not-allowed;background:#e9e9ea;color:#777;box-shadow:none}
  html[data-theme="dark"] .btn:disabled { background: var(--dark-muted); color: #444; }

  .flash-green{animation:flashGreen .45s ease-out}
  .flash-red{animation:flashRed .45s ease-out}
  @keyframes flashGreen{0%{box-shadow:0 6px 0 rgba(0,0,0,0.06)}40%{box-shadow:0 28px 48px 12px rgba(40,200,80,0.6)}100%{box-shadow:0 6px 0 rgba(0,0,0,0.06)}}
  @keyframes flashRed{0%{box-shadow:0 6px 0 rgba(0,0,0,0.06)}40%{box-shadow:0 28px 48px 12px rgba(220,40,40,0.6)}100%{box-shadow:0 6px 0 rgba(0,0,0,0.06)}}
  
  #board{display:flex;justify-content:center;gap:28px;max-width:960px;margin:0 auto;min-height:160px}
  .col{display:flex;flex-direction:column;align-items:center}
  
  #fixedHighscoreFooter {
    position: fixed;
    bottom: 60px; 
    left: 0;
    right: 0;
    text-align: center;
    z-index: 90; 
    pointer-events: none; 
    padding: 0 18px;
    max-width: 960px;
    margin: 0 auto;
  }
  #headerHighscore {
    text-shadow: 0 0 4px rgba(255, 255, 255, 1), 0 0 8px rgba(255, 255, 255, 0.8);
    letter-spacing: 0.5px;
    font-size: 20px; 
    font-weight: 800; 
    color: var(--text);
    line-height: 1.3;
  }
  html[data-theme="dark"] #headerHighscore {
      text-shadow: 0 0 4px rgba(0, 0, 0, 0.8), 0 0 8px rgba(0, 0, 0, 0.6); 
      color: var(--dark-text);
  }

  /* -------------------- End Card / Overlays -------------------- */
  .resultOverlay {
    /* ... (CSS fÃ¼r resultOverlay unverÃ¤ndert Ã¼bernommen) ... */
    max-width: 960px; margin: 0 auto; background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(18px) saturate(200%); -webkit-backdrop-filter: blur(18px) saturate(200%); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 16px; box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3), 0 12px 40px rgba(0, 0, 0, 0.25); padding: 12px 14px; color: var(--text); text-align: center; opacity: 0; max-height: 0; overflow: hidden; margin-bottom: 0px; margin-top: 0px; position: relative; transition: opacity 0.4s ease, max-height 0.4s ease, margin-top 0.4s ease, transform 0.4s ease, top 0.4s ease, width 0.4s ease; z-index: 50; display: flex; justify-content: space-between; align-items: center; 
  }
  html[data-theme="dark"] .resultOverlay {
    background: rgba(0, 0, 0, 0.4); border: 1px solid rgba(255, 255, 255, 0.1);
  }
  .resultOverlay.show {
    opacity: 1; max-height: 200px; margin-top: 24px; margin-bottom: 70px; transform: none; top: auto; width: auto;
  }
  .resultOverlay.floating {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -150%); width: 90%; max-width: 450px; padding: 18px 20px; opacity: 1; max-height: 200px; margin-top: 0; margin-bottom: 0; z-index: 50; 
  }

  .endcard{
    text-align:center; margin-top: 24px; font-size:20px; font-weight:700; line-height:1.5; background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); border-radius: 16px; padding: 12px 14px; width: 100%; max-width: 960px; margin-left: auto; margin-right: auto; box-shadow: 0 8px 24px rgba(0,0,0,0.2); color: var(--text); 
  }
  html[data-theme="dark"] .endcard { background: rgba(0, 0, 0, 0.7); color: var(--dark-text); }
  .endcard b { text-shadow: 0 0 3px rgba(255, 255, 255, 0.6), 0 0 6px rgba(255, 255, 255, 0.4); }
  html[data-theme="dark"] .endcard b { text-shadow: 0 0 3px rgba(0, 0, 0, 0.6), 0 0 6px rgba(0, 0, 0, 0.4); }


  /* -------------------- Pause Layer -------------------- */
  .pauseLayer{position:fixed;left:0;right:0;bottom:0;top:0;display:none;align-items:center;justify-content:center;pointer-events:none;z-index:40}
  .pauseShade{ position:absolute; inset:0; background:rgba(0,0,0,0.1); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); pointer-events:auto }
  .pauseInfo{ position:relative; z-index:41; text-align:center; pointer-events:none; transform: translateY(0px); }
  .pauseCount{ font-size:80px; font-weight:900; color: #000; margin-bottom:12px; text-shadow: 0 0 8px rgba(255, 255, 255, 1), 0 0 16px rgba(255, 255, 255, 0.8), 0 0 24px rgba(255, 255, 255, 0.6); }

  /* -------------------- Modal / Controls -------------------- */
  #newGame{ position:fixed; right:14px; bottom:14px; background:#e53935; color:#fff; border:0; padding:10px 16px; border-radius:30px; cursor:pointer; z-index:100 }
  #controls{position:fixed;left:14px;bottom:14px;display:flex;align-items:center;gap:10px;z-index:100}
  .iconBtn{width:44px;height:44px;border-radius:8px;background:var(--card);display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
  .version{font-size:11px;color:var(--muted);display:block;text-align:center;margin-top:4px}
  .modalShade{position:fixed;inset:0;background:rgba(0,0,0,0.35);display:none;align-items:center;justify-content:center;z-index:200}
  .modal{background:var(--card);padding:18px;border-radius:12px;min-width:320px;max-width:760px;box-shadow:0 12px 40px rgba(0,0,0,0.25);color:var(--text)}
  .modal h2{margin:0 0 8px;font-size:18px}
  .row{display:flex;gap:12px;align-items:center;margin:8px 0}
  .col-auto{display:flex;flex-direction:column;gap:8px}
  .twoCol{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .col-auto label { display: flex; justify-content: space-between; align-items: center; gap: 8px; }
  select,input[type="checkbox"]{padding:8px;font-size:14px}
  select { flex-grow: 1; min-width: 100px; text-align: right; }
  .saveRow{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}
  .soundBtn{padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);background:transparent;cursor:pointer}
  .soundGrid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .small{font-size:13px;color:var(--muted)}
  .modal select, .modal input[type="text"], .modal input[type="checkbox"] + label {
    color: var(--text); background-color: var(--card); 
  }
  
  /* Media Queries */
  @media (max-width:720px){ 
    .modal{width:92%} 
    .pauseCount{font-size:60px} 
    .btn{width:130px} 
    .resultOverlay.show { margin-bottom: 70px; margin-top: 24px; } 
    #fixedHighscoreFooter { bottom: 70px; }
    .scoreboard { padding: 8px 10px; }
    .player-score-box #restBig { font-size: 32px; }
    .game-details #qualityVal { font-size: 16px; }
    .game-details #summary { font-size: 12px; }
  }
</style>
</head>
<body>
<h1>Big-20 | Dart-Training</h1>
<span id="headlineSpacer"></span> 

<div class="scoreboard single-player" id="mainScoreboard">
  <div class="player-score-box active" id="p1ScoreBox">
      <div id="restBig">301</div>
      <div class="player-name" id="p1Name">P1 (Du)</div>
  </div>
  
  <div class="game-details">
    <div id="summary">Treffer: 0 von 0</div>
    <div id="qualityVal">WurfqualitÃ¤t: â€“</div>
  </div>

  <div class="player-score-box" id="p2ScoreBox">
      <div id="p2RestBig">301</div>
      <div class="player-name" id="p2Name">P2 (Gegner)</div>
  </div>
</div>

<div id="board" aria-live="polite">
    <div class="col">
        <button class="btn" data-points="60" data-assign="Triple" onclick="handleClick(this,60,'Triple-20','Triple')">Triple-20</button>
        <button class="btn" data-points="40" data-assign="Double" onclick="handleClick(this,40,'Doppel-20','Double')">Doppel-20</button>
        <button class="btn" data-points="20" data-assign="Single" onclick="handleClick(this,20,'Single-20','Single')">Single-20</button>
    </div>
    <div class="col">
        <button class="btn" data-points="50" data-assign="Bullseye" onclick="handleClick(this,50,'Bulls Eye','Bullseye')">Bulls Eye</button>
        <button class="btn" data-points="25" data-assign="Bull" onclick="handleClick(this,25,'Bull','Bull')">Bull</button>
        <button class="btn" data-points="0" data-assign="Zero" onclick="handleClick(this,0,'Null','Zero')">Null</button>
    </div>
</div>

<div id="resultOverlay" class="resultOverlay"></div>

<div id="fixedHighscoreFooter">
  <div id="headerHighscore">Highscore: -</div>
</div>

<div id="controls">
  <div id="gear" class="iconBtn" title="Einstellungen">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--gear-color)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3" fill="var(--gear-color)" stroke="none"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82-.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0-.33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0 .33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H12a1.65 1.65 0 0 0 1.51-1V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V12a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
  </div>
  <div id="dartIcon" class="iconBtn" title="Informationen">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--dart-color)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6" stroke="var(--dart-color)" fill="var(--dart-color)"></circle><circle cx="12" cy="12" r="2" stroke="#fff" fill="#fff"></circle></svg>
  </div>
  <div class="version" id="versionText">v3.29 Multi-Player</div>
</div>
<button id="newGame">Neues Spiel starten</button>

<div id="readmePopover" class="modalShade" style="z-index: 250;">
    <div class="modal" role="alert" aria-live="polite" style="max-width: 400px; text-align: center; cursor: pointer;">
        <p style="margin: 0; font-size: 16px; font-weight: 600;">Trainiere Triple-20-Treffer und versuche so mÃ¶glichst einen Scorewert von 100% zu erreichen. Es zÃ¤hlen alle 20er-Treffer, sowie Bull und Bulls Eye. Alle anderen Treffer zÃ¤hlen 0</p>
    </div>
</div>

<div id="pauseLayer" class="pauseLayer" aria-hidden="true">
  <div class="pauseShade"></div>
  <div class="pauseInfo" role="status" aria-live="polite">
    <div class="pauseCount" id="pauseCount">5</div>
    <div style="font-size: 20px; font-weight: 700; color: var(--text); background: var(--feedback-bg); padding: 8px 16px; border-radius: 8px; margin-top: 20px;" id="playerSwitchText"></div>
  </div>
</div>
<div id="modalShade" class="modalShade" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
    <h2 id="settingsTitle">Einstellungen & Spiel-Modus</h2>
    
    <h3 style="margin-top:12px;margin-bottom:6px">Spiel-Modus</h3>
    <div class="row">
        <label>
            Spieleranzahl:
            <select id="playerCountSelect" onchange="updatePlayerNames()">
                <option value="1">1 Spieler (301)</option>
                <option value="2">2 Spieler (301)</option>
            </select>
        </label>
    </div>
    <div class="row">
        <label>Spieler 1 Name: <input type="text" id="p1Input" value="P1 (Du)" oninput="updatePlayerNames(true)"></label>
    </div>
    <div class="row" id="p2Row" style="display:none;">
        <label>Spieler 2 Name: <input type="text" id="p2Input" value="P2 (Gegner)" oninput="updatePlayerNames(true)"></label>
    </div>
    <button id="startGameFromSettings" class="btn" style="width:auto;background:var(--good);margin-top:10px;">Spiel starten</button>

    <h3 style="margin-top:12px;margin-bottom:6px">App-Einstellungen</h3>
    <div class="row"><label><input type="checkbox" id="keepAwake"> Display-Timeout 5 Minuten verhindern</label></div>
    <div class="row"><label><input type="checkbox" id="darkModeToggle"> Darkmode (Always-On)</label></div>
    
    <h3 style="margin-top:12px;margin-bottom:6px">Daten</h3>
    <button id="resetData" class="btn" style="width:auto;background:#e53935;">Highscore-Reset</button>
    <p class="small">LÃ¶scht Highscore aus dem Browser. Einstellungen (Darkmode, Sounds, Timeout) bleiben erhalten.</p>
    
    <h3 style="margin-top:12px;margin-bottom:6px">Sound-Zuweisungen</h3>
    <div class="soundGrid" id="soundGrid"></div>
    <div class="twoCol">
      <div class="col-auto">
        <label>Triple-20<select id="sTriple"></select></label>
        <label>Doppel-20<select id="sDouble"></select></label>
        <label>Single-20<select id="sSingle"></select></label>
      </div>
      <div class="col-auto">
        <label>Bulls Eye<select id="sBullseye"></select></label>
        <label>Bull<select id="sBull"></select></label>
        <label>Null<select id="sZero"></select></label>
      </div>
    </div>
    <div class="saveRow">
      <button id="saveSettings" class="btn">Einstellungen speichern</button>
      <button id="closeSettings" class="btn" style="background:#ddd;color:#111">SchlieÃŸen</button>
    </div>
  </div>
</div>
<script>
// **********************************************
// Globale ZustÃ¤nde (Jetzt als Spieler-Array)
// **********************************************
const initialScore = 301;
let players = [];
let currentPlayerIndex = 0;
let isMultiplayer = false;
let inPause = false; 
let wakeLock = null; 
let highscore = { quality: 0, hits: 0, throws: 0, avgQ: 'â€“ %', topThreeSectors: 'â€“ | â€“ | â€“' }; 

const restBig=document.getElementById('restBig'), summary=document.getElementById('summary'), qualityVal=document.getElementById('qualityVal');
const p1ScoreBox = document.getElementById('p1ScoreBox'), p2ScoreBox = document.getElementById('p2ScoreBox');
const p1NameEl = document.getElementById('p1Name'), p2NameEl = document.getElementById('p2Name');
const p2RestBig = document.getElementById('p2RestBig');
const mainScoreboard = document.getElementById('mainScoreboard');

const board=document.getElementById('board');
const highscoreEl=document.getElementById('headerHighscore'); 
const pauseLayer=document.getElementById('pauseLayer'), pauseCount=document.getElementById('pauseCount'), playerSwitchText = document.getElementById('playerSwitchText');
const resultOverlay=document.getElementById('resultOverlay'); 
const gear=document.getElementById('gear'), modalShade=document.getElementById('modalShade'), closeSettings=document.getElementById('closeSettings'), saveSettings=document.getElementById('saveSettings'), resetData=document.getElementById('resetData');
const keepAwake=document.getElementById('keepAwake'), darkModeToggle=document.getElementById('darkModeToggle');
const soundGrid=document.getElementById('soundGrid'), sTriple=document.getElementById('sTriple'), sDouble=document.getElementById('sDouble'), sSingle=document.getElementById('sSingle'), sBullseye=document.getElementById('sBullseye'), sBull=document.getElementById('sBull'), sZero=document.getElementById('sZero');
const qualityMap={60:100,50:83.33,40:66.67,25:41.67,20:33.33,0:0};
const AudioContextClass = window.AudioContext || window.webkitAudioContext;
const audioCtx = new AudioContextClass();
const soundPresets=[ {name:'Click 1',type:'sine',freq:800},{name:'Click 2',type:'sine',freq:1000},{name:'Pop',type:'square',freq:600}, {name:'Beep',type:'sine',freq:1100},{name:'Tock',type:'triangle',freq:700},{name:'Ping',type:'sine',freq:1400}, {name:'Blip',type:'square',freq:900},{name:'Clack',type:'triangle',freq:650},{name:'Ding',type:'sine',freq:1200}, {name:'Tick',type:'square',freq:500},{name:'Zing',type:'sawtooth',freq:1500},{name:'Tone',type:'sine',freq:400} ];
let soundAssign={Triple:0,Double:1,Single:2,Bullseye:3,Bull:4,Zero:5};

// Readme Elemente
const dartIcon = document.getElementById('dartIcon');
const readmePopover = document.getElementById('readmePopover');

// Einstellungs-Elemente fÃ¼r Multiplayer
const playerCountSelect = document.getElementById('playerCountSelect');
const p1Input = document.getElementById('p1Input');
const p2Input = document.getElementById('p2Input');
const p2Row = document.getElementById('p2Row');
const startGameFromSettings = document.getElementById('startGameFromSettings');

// **********************************************
// Initialisierung und Player-Setup
// **********************************************

function initializePlayers(numPlayers, p1Name, p2Name) {
    currentPlayerIndex = 0;
    isMultiplayer = numPlayers > 1;

    // Lade Namen aus LocalStorage oder verwende Defaults
    const storedP1Name = localStorage.getItem('big20_p1Name') || p1Name;
    const storedP2Name = localStorage.getItem('big20_p2Name') || p2Name;

    players = [
        { 
            name: storedP1Name,
            score: initialScore,
            scoreBeforeBust: initialScore,
            throws: 0,
            hits: 0,
            qualitySum: 0,
            roundThrows: 0,
            lastThree: [],
            sectorCounts: {Triple: 0, Double: 0, Single: 0, Bullseye: 0, Bull: 0, Zero: 0}
        }
    ];

    if (isMultiplayer) {
        players.push({
            name: storedP2Name,
            score: initialScore,
            scoreBeforeBust: initialScore,
            throws: 0,
            hits: 0,
            qualitySum: 0,
            roundThrows: 0,
            lastThree: [],
            sectorCounts: {Triple: 0, Double: 0, Single: 0, Bullseye: 0, Bull: 0, Zero: 0}
        });
        
        // Update Scoreboard UI fÃ¼r Multi-Player
        mainScoreboard.classList.remove('single-player');
        p1NameEl.textContent = players[0].name;
        p2NameEl.textContent = players[1].name;
        p2NameEl.parentElement.style.display = 'block'; // Zeige P2 Score Box
        
    } else {
        // Update Scoreboard UI fÃ¼r Single-Player
        mainScoreboard.classList.add('single-player');
        p1NameEl.textContent = players[0].name;
        p2NameEl.parentElement.style.display = 'none'; // Verstecke P2 Score Box
    }
}

function updatePlayerNames(save=false) {
    const isMulti = playerCountSelect.value === '2';
    
    // Update Modal UI
    p2Row.style.display = isMulti ? 'flex' : 'none';
    
    // Update in-game UI (nur wenn nicht gerade ein Spiel lÃ¤uft)
    if (players.length > 0) {
        p1NameEl.textContent = p1Input.value;
        if (isMulti) {
            p2NameEl.textContent = p2Input.value;
        }
    }

    if (save) {
        localStorage.setItem('big20_p1Name', p1Input.value);
        localStorage.setItem('big20_p2Name', p2Input.value);
    }
}

// **********************************************
// Highscore-Logik (unverÃ¤ndert, gilt nur fÃ¼r den aktuellen Spieler)
// **********************************************
function getTopThreeSectors(counts) {
    const sectorArray = Object.keys(counts).map(key => ({
        label: key === 'Zero' ? '0' : key.replace(/Triple|Double|Single/, (m) => {
            if(m === 'Triple') return 'Triple-20';
            if(m === 'Double') return 'Doppel-20';
            if(m === 'Single') return '20'; 
            return m;
        }),
        count: counts[key]
    }));

    sectorArray.sort((a, b) => b.count - a.count);

    const topThree = sectorArray.slice(0, 3).filter(s => s.count > 0);
    
    if (topThree.length === 0) return 'â€“ | â€“ | â€“';
    
    const labels = topThree.map(s => s.label + (s.count > 0 ? ` (${s.count})` : ''));
    while (labels.length < 3) {
        labels.push('â€“');
    }

    return labels.join(' | ');
}

function loadHighscore(){
  try{
    const hs = JSON.parse(localStorage.getItem('big20_highscore') || '{}');
    
    highscore = { quality: 0, hits: 0, throws: 0, avgQ: 'â€“ %', topThreeSectors: 'â€“ | â€“ | â€“' }; 

    if (hs.quality !== undefined && (parseInt(hs.quality) > 0 || parseInt(hs.hits) > 0)) {
        highscore.quality = parseInt(hs.quality) || 0; 
        highscore.hits = parseInt(hs.hits) || 0;       
        highscore.throws = parseInt(hs.throws) || 0;   
        highscore.avgQ = hs.avgQ || 'â€“ %';    
        highscore.topThreeSectors = hs.topThreeSectors || 'â€“ | â€“ | â€“'; 
    }
  } catch(e) {
    console.warn('Highscore konnte nicht geladen werden', e);
  }
  updateHighscoreUI(); 
}

function saveHighscore(finalQuality, finalHits, finalThrows, finalAvgString, sectorCounts){
  const topThreeSectorsString = getTopThreeSectors(sectorCounts);

  if (finalQuality > highscore.quality || (highscore.quality === 0 && finalQuality > 0)) {
    highscore.quality = finalQuality;
    highscore.hits = finalHits;
    highscore.throws = finalThrows;
    highscore.avgQ = finalAvgString;
    highscore.topThreeSectors = topThreeSectorsString; 
    localStorage.setItem('big20_highscore', JSON.stringify(highscore));
    updateHighscoreUI();
    return true; 
  }
  return false;
}

function updateHighscoreUI(){
  const quality = highscore.quality || 0;
  const hits = highscore.hits || 0;
  const throws = highscore.throws || 0;
  const topThree = highscore.topThreeSectors || 'â€“ | â€“ | â€“';
  
  // Zeilenumbruch vor Top 3, kein senkrechter Strich
  highscoreEl.innerHTML = `Highscore: ${quality} % | ${hits} Treffer von ${throws} <br> Top 3: ${topThree}`;
}

// **********************************************
// Einstellungs-Logik (unverÃ¤ndert)
// **********************************************
function loadSettings(){ 
    try{ 
        const s=JSON.parse(localStorage.getItem('big20_settings')||'{}'); 
        if(s.soundAssign) soundAssign=s.soundAssign; 
        
        if(s.darkMode){ 
            document.documentElement.setAttribute('data-theme','dark'); 
            darkModeToggle.checked=true;
        } else { 
            document.documentElement.removeAttribute('data-theme');
            darkModeToggle.checked=false;
        }
        
        if(s.keepAwake){ 
            keepAwake.checked=true; 
            requestWakeLock(); 
        } else {
            keepAwake.checked=false;
            releaseWakeLock();
        }
        
        // Multi-Player Settings
        const numPlayers = parseInt(localStorage.getItem('big20_numPlayers') || '1');
        playerCountSelect.value = numPlayers;
        p1Input.value = localStorage.getItem('big20_p1Name') || 'P1 (Du)';
        p2Input.value = localStorage.getItem('big20_p2Name') || 'P2 (Gegner)';
        updatePlayerNames(); // Update UI
    }catch(e){console.warn(e);} 
}
function saveSettingsToStore(){ 
    const obj={
        soundAssign, 
        darkMode: !!darkModeToggle.checked, 
        keepAwake: !!keepAwake.checked
    }; 
    localStorage.setItem('big20_settings', JSON.stringify(obj)); 
    localStorage.setItem('big20_numPlayers', playerCountSelect.value);
    localStorage.setItem('big20_p1Name', p1Input.value);
    localStorage.setItem('big20_p2Name', p2Input.value);
}

// **********************************************
// UI Logik (Angepasst fÃ¼r Multi-Player)
// **********************************************
function computeQualityDisplay(player){ 
    if(player.throws===0) return 'WurfqualitÃ¤t: â€“'; 
    return 'WurfqualitÃ¤t: '+Math.round(player.qualitySum/player.throws)+' %'; 
}

function updateUI(){ 
    const p = players[currentPlayerIndex];

    // Aktueller Spieler-Score und Name (Muss immer auf P1 Score Box projiziert werden, wenn SP-Modus)
    // In MP-Modus: restBig zeigt den Score des *aktiven* Spielers (P1 oder P2)
    restBig.textContent = players[0].score; // P1 Score
    p2RestBig.textContent = isMultiplayer ? players[1].score : ''; // P2 Score

    // Statistik-Anzeige (gilt immer fÃ¼r den aktiven Spieler)
    summary.textContent = `Treffer: ${p.hits} von ${p.throws}`; 
    qualityVal.textContent = computeQualityDisplay(p); 
    
    // Aktiver Spieler-Highlight
    p1ScoreBox.classList.toggle('active', currentPlayerIndex === 0);
    p2ScoreBox.classList.toggle('active', isMultiplayer && currentPlayerIndex === 1);

    updateHighscoreUI(); 
    updateButtonStates(); 
} 

function updateButtonStates() {
    const p = players[currentPlayerIndex];
    const buttons = board.querySelectorAll('.btn');
    // Board komplett ausblenden, wenn Spiel beendet oder in Pause
    board.style.display = (p.score === 0 || inPause) ? 'none' : 'flex';
    
    if (p.score === 0 || inPause) return;

    buttons.forEach(btn => {
        const points = parseInt(btn.getAttribute('data-points'));
        let disabled = false;
        
        if (points > 0) {
            const potential = p.score - points;
            // BUST-Kriterium: Der Rest ist 1 oder negativ (auÃŸer er ist genau 0)
            if (potential <= 1 && potential !== 0) {
                disabled = true;
            }
            if (points > p.score) {
                disabled = true;
            }
        }
        
        if (points === 0) {
            disabled = false;
        }

        btn.disabled = disabled;
    });
}

// **********************************************
// Kern-Spiellogik (Angepasst fÃ¼r Multi-Player)
// **********************************************

function handleClick(btnEl, points, label, assignKey) {
  const p = players[currentPlayerIndex];
  if (inPause || p.score === 0) return;

  // 1. Visuelles Feedback (Flash)
  const isHit = points > 0;
  btnEl.style.transition = "background-color 0.15s ease";
  btnEl.style.backgroundColor = isHit ? "rgba(0,255,0,0.6)" : "rgba(255,0,0,0.6)";
  setTimeout(() => { btnEl.style.backgroundColor = ""; }, 200);
  if (navigator.vibrate) navigator.vibrate(30);
  // flashVisual(btnEl, isHit); // Flash Visual entfernt, da es in der Originalversion nicht vorhanden war und zu Konflikten fÃ¼hren kann.

  // 2. Sound
  const idx = soundAssign[assignKey] !== undefined ? soundAssign[assignKey] : 0;
  playSound(idx);

  // 3. Scoring
  scoring(points, label, assignKey);
}

function flashVisual(el,hit){ el.classList.remove('flash-green','flash-red'); void el.offsetWidth; el.classList.add(hit?'flash-green':'flash-red'); setTimeout(()=>{ el.classList.remove('flash-green','flash-red'); },460); }
function playSound(index){ try{ const p=soundPresets[index]; if(!p) return; const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type=p.type; o.frequency.value=p.freq; g.gain.value=0.0001; o.connect(g); g.connect(audioCtx.destination); const now=audioCtx.currentTime; g.gain.setValueAtTime(0.0001,now); g.gain.exponentialRampToValueAtTime(0.18, now+0.005); o.start(now); g.gain.exponentialRampToValueAtTime(0.0001, now+0.18); o.stop(now+0.21); }catch(e){console.warn('audio err',e);} }


function scoring(points,label,assignKey){ 
  const p = players[currentPlayerIndex];
  
  if (p.roundThrows === 0) { 
      resultOverlay.classList.remove('show', 'floating');
      p.scoreBeforeBust = p.score; // Speichere Score fÃ¼r mÃ¶glichen Bust
  }

  p.throws++; 
  p.roundThrows++; 
  
  if(p.sectorCounts.hasOwnProperty(assignKey) && points > 0){
      p.sectorCounts[assignKey]++;
  }

  const potential = p.score - points; 
  const bust = (potential < 0 || potential === 1); // BUST condition: < 0 OR = 1
  
  if(bust){ 
    // **BUST-Handling**
    p.qualitySum += qualityMap[0]; 
    p.lastThree.push({label:label + ' (BUST)',points:0,q:0}); 
    if(p.lastThree.length>3) p.lastThree.shift(); 
    p.score = p.scoreBeforeBust; 
    
    // Runde ist vorbei (forcierter Wechsel)
    p.roundThrows = 3; 
    
    updateUI(); 
    checkPause(); 
    return; 
  } 
  
  // **REGULAR HIT/MISS**
  p.score = potential; 
  if(points>0) p.hits++; 
  
  let q = (qualityMap[points]!==undefined)? qualityMap[points]:0; 
  if(p.score===0) q=100; // 100% quality for a checkout
  p.qualitySum += q; 
  p.lastThree.push({label:label,points:points,q: Math.round(q)}); 
  if(p.lastThree.length>3) p.lastThree.shift(); 
  
  updateUI(); 
  
  if(p.score===0){ 
    updateButtonStates(); // Board ausblenden
    announceEnd(p); 
    return;
  }
  
  checkPause(); 
}

function checkPause(){ 
    const p = players[currentPlayerIndex];
    if(p.roundThrows>=3){ 
        p.roundThrows=0; 
        
        if (isMultiplayer) {
            // Spieler wechseln
            currentPlayerIndex = (currentPlayerIndex + 1) % players.length;
            playerSwitchText.textContent = `NÃ¤chster Spieler: ${players[currentPlayerIndex].name}`;
        } else {
            // Im Single-Player-Modus bleibt der Text leer
            playerSwitchText.textContent = '';
        }
        
        startPause(); 
    } 
}

function startPause(){ 
  inPause=true; 
  const p = players[currentPlayerIndex]; // Der Spieler, der gerade geworfen hat

  // 1. Pause Layer (Hintergrund und Countdown) anzeigen
  pauseLayer.style.display='flex'; 
  pauseLayer.setAttribute('aria-hidden','false'); 
  
  const arr=p.lastThree.slice(-3); 
  const totalPoints = arr.reduce((sum, x) => sum + (x.points || 0), 0);
  const roundHits = arr.filter(x => x.points > 0).length;
  const avg = arr.length>0? Math.round(arr.reduce((s,x)=>s+(x.q||0),0)/arr.length):0; 
  const scoreColor = (totalPoints>0 && arr.some(x => x.label.includes('(BUST)') === false)) ? 'var(--good)' : 'var(--bad)';
  
  // 2. Persistent Overlay direkt im Floating Zustand anzeigen (zeigt die Ergebnisse des letzten Werfers)
  resultOverlay.innerHTML = `
    <div style="text-align: left;">
        <div style="color: var(--muted); font-size: 14px;">${p.name}'s letzter Wurf</div>
        <div style="font-size: 44px; font-weight: 900; color: ${scoreColor}; margin: 6px 0;">${totalPoints}</div>
    </div>
    <div style="text-align:right;">
        <div style="display: block; font-size: 13px; font-weight: 500; margin-top: 4px; color: var(--muted);">${roundHits} Treffer</div>
        <div style="font-size: 20px; font-weight: 800; margin-top: 6px;">WurfqualitÃ¤t: ${avg} %</div>
    </div>
  `;
  resultOverlay.classList.remove('show');
  resultOverlay.classList.add('floating');
  
  let t=5; 
  pauseCount.textContent=t; 
  const iv=setInterval(()=>{ 
    t--; 
    pauseCount.textContent=t; 
    if(t<=0){ 
      clearInterval(iv); 
      endPause(); 
    } 
  },1000);
}

function endPause(){ 
    inPause=false; 
    
    // Box wird JETZT in die finale (obere) Position animiert
    resultOverlay.classList.remove('floating'); 
    resultOverlay.classList.add('show');       

    // Pause Layer (Hintergrund und Countdown) ausblenden
    pauseLayer.style.display='none'; 
    pauseLayer.setAttribute('aria-hidden','true');
    
    // UI aktualisieren, um den neuen aktiven Spieler anzuzeigen
    updateUI(); 
}

function announceEnd(winner){ 
    const finalAvg = winner.throws>0?Math.round(winner.qualitySum/winner.throws):0; 
    const finalHits = winner.hits;
    const finalThrows = winner.throws;
    const finalAvgStr = finalAvg + ' %';
    
    // Highscore nur im Single-Player Modus speichern
    let isNewHighscore = false;
    if (!isMultiplayer) {
        isNewHighscore = saveHighscore(finalAvg, finalHits, finalThrows, finalAvgStr, winner.sectorCounts);
    }

    pauseLayer.style.display='none'; 
    pauseLayer.setAttribute('aria-hidden','true'); 
    resultOverlay.classList.remove('show', 'floating'); 

    const card=document.createElement('div'); 
    card.className='endcard'; 
    
    let endMessage = `ðŸŽ¯ <b>SPIELENDE!</b> ${winner.name} hat ausgecheckt.`;
    
    if (!isMultiplayer) {
        endMessage = `ðŸŽ¯ <b>Spiel beendet!</b>`;
    }
    
    card.innerHTML = `${endMessage}<br><br>${finalHits} Treffer von ${finalThrows} WÃ¼rfen<br>WurfqualitÃ¤t: ${finalAvg} %`;
    
    if (isNewHighscore) {
        card.innerHTML += '<br><br>ðŸŽ‰ **NEUER HIGHSCORE!**';
    }
    
    board.innerHTML = '';
    board.style.display = 'flex'; 
    board.appendChild(card); 
}

// **********************************************
// Setup & Events (UnverÃ¤ndert/Angepasst)
// **********************************************
function newGame() {
    const numPlayers = parseInt(playerCountSelect.value);
    initializePlayers(numPlayers, p1Input.value, p2Input.value);
    
    // Ensure the board is back to normal buttons
    board.innerHTML = ''; 
    board.appendChild(document.querySelector('.col:first-child').cloneNode(true));
    board.appendChild(document.querySelector('.col:last-child').cloneNode(true));
    
    currentPlayerIndex = 0;
    inPause = false; 
    document.getElementById('pauseLayer').style.display='none'; 
    resultOverlay.classList.remove('show', 'floating'); 
    
    updateUI(); 
    updateButtonStates(); 
    
    // Close modal if game was started from settings
    document.getElementById('modalShade').style.display='none'; 
    document.getElementById('modalShade').setAttribute('aria-hidden','true'); 
}

function resetAllData() {
    if (confirm('Sind Sie sicher, dass Sie den gespeicherten Highscore lÃ¶schen mÃ¶chten?')) {
        localStorage.removeItem('big20_highscore');
        loadHighscore();
        alert('Der Highscore wurde gelÃ¶scht.');
        document.getElementById('modalShade').style.display='none'; 
        document.getElementById('modalShade').setAttribute('aria-hidden','true'); 
    }
}

function buildSoundUI(){ 
    // ... (Sound UI und Logic unverÃ¤ndert) ...
    soundGrid.innerHTML=''; 
    soundPresets.forEach((s,i)=>{ const b=document.createElement('button'); b.className='soundBtn'; b.textContent=s.name; b.onclick=()=>playSound(i); soundGrid.appendChild(b); [sTriple,sDouble,sSingle,sBullseye,sBull,sZero].forEach(sel=>{ const opt=document.createElement('option'); opt.value=i; opt.textContent=s.name; sel.appendChild(opt); }); }); 
    sTriple.value=soundAssign.Triple; sDouble.value=soundAssign.Double; sSingle.value=soundAssign.Single; sBullseye.value=soundAssign.Bullseye; sBull.value=soundAssign.Bull; sZero.value=soundAssign.Zero; 
}

function requestWakeLock(){ try{ if('wakeLock' in navigator){ navigator.wakeLock.request('screen').then(wl=>{ wakeLock=wl; wl.addEventListener('release',()=>{ wakeLock=null; }); }).catch(e=>console.warn('wake lock request failed',e)); } }catch(e){console.warn(e);} }
function releaseWakeLock(){ try{ if(wakeLock){ wakeLock.release().catch(()=>{}); wakeLock=null; } }catch(e){console.warn(e);} }


document.getElementById('saveSettings').onclick = ()=>{ 
    soundAssign = {
        Triple: parseInt(sTriple.value), Double: parseInt(sDouble.value), Single: parseInt(sSingle.value), 
        Bullseye: parseInt(sBullseye.value), Bull: parseInt(sBull.value), Zero: parseInt(sZero.value)
    }; 
    
    if(darkModeToggle.checked){
        document.documentElement.setAttribute('data-theme','dark');
    } else {
        document.documentElement.removeAttribute('data-theme');
    }

    if(keepAwake.checked) requestWakeLock(); else releaseWakeLock(); 
    
    saveSettingsToStore(); 
    document.getElementById('modalShade').style.display='none'; 
    document.getElementById('modalShade').setAttribute('aria-hidden','true'); 
};

resetData.onclick = resetAllData;

document.getElementById('gear').onclick = ()=>{ 
    readmePopover.style.display='none'; 
    document.getElementById('modalShade').style.display='flex'; 
    document.getElementById('modalShade').setAttribute('aria-hidden','false'); 
};

dartIcon.onclick = (e) => {
    e.stopPropagation(); 
    document.getElementById('modalShade').style.display='none'; 
    document.getElementById('modalShade').setAttribute('aria-hidden','true');
    
    if (readmePopover.style.display === 'flex') {
        readmePopover.style.display = 'none';
        readmePopover.setAttribute('aria-hidden', 'true');
    } else {
        readmePopover.style.display = 'flex';
        readmePopover.setAttribute('aria-hidden', 'false');
    }
};

readmePopover.onclick = () => {
    readmePopover.style.display = 'none';
    readmePopover.setAttribute('aria-hidden', 'true');
};

document.getElementById('closeSettings').onclick = ()=>{ 
    document.getElementById('modalShade').style.display='none'; 
    document.getElementById('modalShade').setAttribute('aria-hidden','true'); 
    loadSettings(); 
};

document.getElementById('newGame').onclick = newGame;
document.getElementById('startGameFromSettings').onclick = newGame;


// **********************************************
// INITIALISIERUNG
// **********************************************
buildSoundUI(); 
loadHighscore(); 
loadSettings(); 
// Initiales Spiel starten
newGame(); 
</script>
</body>
</html>
